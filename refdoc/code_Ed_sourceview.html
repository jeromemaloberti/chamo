<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of class attributes" rel=Appendix href="index_attributes.html">
<link title="Index of class methods" rel=Appendix href="index_methods.html">
<link title="Index of classes" rel=Appendix href="index_classes.html">
<link title="Index of class types" rel=Appendix href="index_class_types.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Ed_annot" rel="Chapter" href="Ed_annot.html">
<link title="Ed_args" rel="Chapter" href="Ed_args.html">
<link title="Ed_bookmarks" rel="Chapter" href="Ed_bookmarks.html">
<link title="Ed_charsets" rel="Chapter" href="Ed_charsets.html">
<link title="Ed_com_history" rel="Chapter" href="Ed_com_history.html">
<link title="Ed_commands" rel="Chapter" href="Ed_commands.html">
<link title="Ed_config" rel="Chapter" href="Ed_config.html">
<link title="Ed_constant" rel="Chapter" href="Ed_constant.html">
<link title="Ed_core_rc" rel="Chapter" href="Ed_core_rc.html">
<link title="Ed_dbg" rel="Chapter" href="Ed_dbg.html">
<link title="Ed_eval" rel="Chapter" href="Ed_eval.html">
<link title="Ed_extern" rel="Chapter" href="Ed_extern.html">
<link title="Ed_fstack" rel="Chapter" href="Ed_fstack.html">
<link title="Ed_gtk_misc" rel="Chapter" href="Ed_gtk_misc.html">
<link title="Ed_gui" rel="Chapter" href="Ed_gui.html">
<link title="Ed_gui_base" rel="Chapter" href="Ed_gui_base.html">
<link title="Ed_gui_rc" rel="Chapter" href="Ed_gui_rc.html">
<link title="Ed_hooks" rel="Chapter" href="Ed_hooks.html">
<link title="Ed_installation" rel="Chapter" href="Ed_installation.html">
<link title="Ed_keymaps" rel="Chapter" href="Ed_keymaps.html">
<link title="Ed_layout" rel="Chapter" href="Ed_layout.html">
<link title="Ed_log" rel="Chapter" href="Ed_log.html">
<link title="Ed_main" rel="Chapter" href="Ed_main.html">
<link title="Ed_messages" rel="Chapter" href="Ed_messages.html">
<link title="Ed_minibuffer" rel="Chapter" href="Ed_minibuffer.html">
<link title="Ed_minibuffer_rc" rel="Chapter" href="Ed_minibuffer_rc.html">
<link title="Ed_misc" rel="Chapter" href="Ed_misc.html">
<link title="Ed_mode_changelog" rel="Chapter" href="Ed_mode_changelog.html">
<link title="Ed_mode_changelog_rc" rel="Chapter" href="Ed_mode_changelog_rc.html">
<link title="Ed_mode_makefile" rel="Chapter" href="Ed_mode_makefile.html">
<link title="Ed_mode_makefile_rc" rel="Chapter" href="Ed_mode_makefile_rc.html">
<link title="Ed_mode_ocaml" rel="Chapter" href="Ed_mode_ocaml.html">
<link title="Ed_mode_ocaml_rc" rel="Chapter" href="Ed_mode_ocaml_rc.html">
<link title="Ed_multiclip" rel="Chapter" href="Ed_multiclip.html">
<link title="Ed_multiclip_rc" rel="Chapter" href="Ed_multiclip_rc.html">
<link title="Ed_ocamlbuild" rel="Chapter" href="Ed_ocamlbuild.html">
<link title="Ed_ocamloutput" rel="Chapter" href="Ed_ocamloutput.html">
<link title="Ed_odoc" rel="Chapter" href="Ed_odoc.html">
<link title="Ed_odoc_rc" rel="Chapter" href="Ed_odoc_rc.html">
<link title="Ed_outputs" rel="Chapter" href="Ed_outputs.html">
<link title="Ed_prefs" rel="Chapter" href="Ed_prefs.html">
<link title="Ed_rc" rel="Chapter" href="Ed_rc.html">
<link title="Ed_sourceview" rel="Chapter" href="Ed_sourceview.html">
<link title="Ed_sourceview_expand" rel="Chapter" href="Ed_sourceview_expand.html">
<link title="Ed_sourceview_rc" rel="Chapter" href="Ed_sourceview_rc.html">
<link title="Ed_utf8" rel="Chapter" href="Ed_utf8.html">
<link title="Ed_view" rel="Chapter" href="Ed_view.html">
<link title="Ed_view_rc" rel="Chapter" href="Ed_view_rc.html">
<link title="Ed_xml" rel="Chapter" href="Ed_xml.html">
<link title="Multiclip" rel="Chapter" href="Multiclip.html">
<link title="Multiclip_gui" rel="Chapter" href="Multiclip_gui.html"><title>Chamo library : Ed_sourceview</title>
</head>
<body>
<code class="code"></code><table><tr><td></td><td><span class="comment">(*********************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Chamo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;Copyright&nbsp;(C)&nbsp;2003-2012&nbsp;Institut&nbsp;National&nbsp;de&nbsp;Recherche&nbsp;en&nbsp;Informatique&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;et&nbsp;en&nbsp;Automatique.&nbsp;All&nbsp;rights&nbsp;reserved.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;program&nbsp;is&nbsp;free&nbsp;software;&nbsp;you&nbsp;can&nbsp;redistribute&nbsp;it&nbsp;and/or&nbsp;modify&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;under&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;GNU&nbsp;Lesser&nbsp;General&nbsp;Public&nbsp;License&nbsp;version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;as&nbsp;published&nbsp;by&nbsp;the&nbsp;Free&nbsp;Software&nbsp;Foundation.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;program&nbsp;is&nbsp;distributed&nbsp;in&nbsp;the&nbsp;hope&nbsp;that&nbsp;it&nbsp;will&nbsp;be&nbsp;useful,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;but&nbsp;WITHOUT&nbsp;ANY&nbsp;WARRANTY;&nbsp;without&nbsp;even&nbsp;the&nbsp;implied&nbsp;warranty&nbsp;of&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;MERCHANTABILITY&nbsp;or&nbsp;FITNESS&nbsp;FOR&nbsp;A&nbsp;PARTICULAR&nbsp;PURPOSE.&nbsp;&nbsp;See&nbsp;the&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;GNU&nbsp;General&nbsp;Public&nbsp;License&nbsp;for&nbsp;more&nbsp;details.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;You&nbsp;should&nbsp;have&nbsp;received&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;GNU&nbsp;General&nbsp;Public&nbsp;License&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;along&nbsp;with&nbsp;this&nbsp;program;&nbsp;if&nbsp;not,&nbsp;write&nbsp;to&nbsp;the&nbsp;Free&nbsp;Software&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;Foundation,&nbsp;Inc.,&nbsp;59&nbsp;Temple&nbsp;Place,&nbsp;Suite&nbsp;330,&nbsp;Boston,&nbsp;MA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;02111-1307&nbsp;&nbsp;USA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;Contact:&nbsp;Maxence.Guesdon@inria.fr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(*********************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Source views *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;_&nbsp;=&nbsp;<span class="constructor">Ed_sourceview_rc</span>.read&nbsp;();;<br>
<span class="keyword">let</span>&nbsp;_&nbsp;=&nbsp;<span class="constructor">Ed_sourceview_rc</span>.write&nbsp;();;<br>
<span class="constructor">Gtksv_utils</span>.set_source_style_scheme&nbsp;(<span class="constructor">Gtksv_utils</span>.read_style_scheme_selection());;<br>
<br>
<span class="keyword">let</span>&nbsp;factory_name&nbsp;=&nbsp;<span class="constructor">Ed_sourceview_rc</span>.factory_name<br>
<br>
<span class="keyword">let</span>&nbsp;get_att&nbsp;name&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">List</span>.assoc&nbsp;name&nbsp;l)<br>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<br>
<span class="keyword">let</span>&nbsp;get_att_f&nbsp;?default&nbsp;f&nbsp;name&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;get_att&nbsp;name&nbsp;l&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;default<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;(f&nbsp;s)<br>
;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Languages">Languages</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;language_manager&nbsp;=&nbsp;<span class="constructor">Gtksv_utils</span>.source_language_manager<br>
<br>
<span class="keyword">let</span>&nbsp;lang_of_filename&nbsp;filename&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(_,mime)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(re,_)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;re&nbsp;=&nbsp;<span class="constructor">Str</span>.regexp&nbsp;re&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Str</span>.string_match&nbsp;re&nbsp;filename&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_sourceview_rc</span>.filename_language_patterns<span class="keywordsign">#</span>get<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;language_manager<span class="keywordsign">#</span>guess_language&nbsp;~content_type:&nbsp;mime&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Utilities">Utilities</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;utf8_of_filename&nbsp;?(full=<span class="keyword">false</span>)&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Glib</span>.<span class="constructor">Convert</span>.filename_to_utf8&nbsp;(<span class="keyword">if</span>&nbsp;full&nbsp;<span class="keyword">then</span>&nbsp;f&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">Filename</span>.basename&nbsp;f)<br>
<br>
<span class="keyword">type</span>&nbsp;location&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Linechar</span>&nbsp;<span class="keyword">of</span>&nbsp;int&nbsp;*&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Linechars</span>&nbsp;<span class="keyword">of</span>&nbsp;int&nbsp;*&nbsp;(int&nbsp;*&nbsp;int)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Char</span>&nbsp;<span class="keyword">of</span>&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Chars</span>&nbsp;<span class="keyword">of</span>&nbsp;int&nbsp;*&nbsp;int<br>
<br>
<span class="keyword">let</span>&nbsp;location_of_string&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;a&nbsp;b&nbsp;c&nbsp;=&nbsp;<span class="constructor">Linechars</span>&nbsp;(a,&nbsp;(b,&nbsp;c))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Scanf</span>.sscanf&nbsp;s&nbsp;<span class="string">"%d,%d-%d"</span>&nbsp;f)<br>
&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;a&nbsp;b&nbsp;=&nbsp;<span class="constructor">Linechar</span>(a,b)&nbsp;<span class="keyword">in</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Scanf</span>.sscanf&nbsp;s&nbsp;<span class="string">"%d,%d"</span>&nbsp;f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;a&nbsp;b&nbsp;=&nbsp;<span class="constructor">Chars</span>(a,b)&nbsp;<span class="keyword">in</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Scanf</span>.sscanf&nbsp;s&nbsp;<span class="string">"%d-%d"</span>&nbsp;f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Char</span>(<span class="constructor">Ed_misc</span>.my_int_of_string&nbsp;s))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
;;<br>
<span class="keyword">let</span>&nbsp;string_of_location&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="constructor">Linechar</span>&nbsp;(l,&nbsp;c)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%d,%d"</span>&nbsp;l&nbsp;c<br>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Linechars</span>&nbsp;(l,&nbsp;(c1,c2))&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%d,%d-%d"</span>&nbsp;l&nbsp;c1&nbsp;c2<br>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Char</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string_of_int&nbsp;c<br>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Chars</span>&nbsp;(c1,c2)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%d-%d"</span>&nbsp;c1&nbsp;c2<br>
;;<br>
<br>
<span class="keyword">let</span>&nbsp;string_of_line_char&nbsp;(l,c)&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%d,%d"</span>&nbsp;l&nbsp;c<br>
<br>
<span class="keyword">let</span>&nbsp;location_of_iter&nbsp;iter&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;char&nbsp;=&nbsp;iter<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;line_start&nbsp;=&nbsp;(iter<span class="keywordsign">#</span>set_line_offset&nbsp;0)<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;(iter<span class="keywordsign">#</span>line,&nbsp;char&nbsp;-&nbsp;line_start)<br>
;;<br>
<span class="keyword">let</span>&nbsp;line_char_of_location&nbsp;b&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(0,0)<br>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Linechar</span>&nbsp;(l,c))&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(l,c)<br>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Linechars</span>&nbsp;(l,(c,_)))&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(l,c)<br>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Char</span>&nbsp;c)<br>
<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Chars</span>&nbsp;(c,_))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;c)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(location_of_iter&nbsp;it)<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Bookmarks">Bookmarks</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;bookmarks&nbsp;=&nbsp;<span class="constructor">Ed_bookmarks</span>.create_from_cf_wrappers<br>
&nbsp;&nbsp;~desc:&nbsp;<span class="string">"Sourceviews&nbsp;bookmarks"</span><br>
&nbsp;&nbsp;(<span class="constructor">Config_file</span>.tuple3_wrappers&nbsp;<span class="constructor">Config_file</span>.string_wrappers<br>
&nbsp;&nbsp;&nbsp;<span class="constructor">Config_file</span>.int_wrappers&nbsp;<span class="constructor">Config_file</span>.int_wrappers);;<br>
<span class="keyword">let</span>&nbsp;_&nbsp;=&nbsp;<span class="constructor">Ed_bookmarks</span>.load&nbsp;bookmarks&nbsp;<span class="constructor">Ed_sourceview_rc</span>.bookmarks_rc_file;;<br>
<span class="keyword">let</span>&nbsp;store_bookmarks&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Ed_bookmarks</span>.store&nbsp;bookmarks&nbsp;<span class="constructor">Ed_sourceview_rc</span>.bookmarks_rc_file;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Savingandloadingopenbuffers">Saving and loading open buffers</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;open_buffers_file&nbsp;=<br>
&nbsp;&nbsp;ref&nbsp;(<span class="constructor">Ed_config</span>.local_dir_rc_file&nbsp;(factory_name^<span class="string">".buffers"</span>))<br>
<br>
<span class="keyword">let</span>&nbsp;xml_of_file&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;atts&nbsp;=&nbsp;((<span class="string">""</span>,<span class="string">"file"</span>),&nbsp;f<span class="keywordsign">#</span>filename)&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;(<span class="keyword">fun</span>&nbsp;(a,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;((<span class="string">""</span>,a),&nbsp;v))&nbsp;f<span class="keywordsign">#</span>attributes)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_xml</span>.<span class="constructor">E</span>&nbsp;(((<span class="string">""</span>,<span class="string">"file"</span>),&nbsp;atts),&nbsp;[])<br>
<br>
<span class="keyword">let</span>&nbsp;xml_of_file_list&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Ed_xml</span>.<span class="constructor">E</span>&nbsp;(((<span class="string">""</span>,<span class="string">"list"</span>),&nbsp;[]),&nbsp;<span class="constructor">List</span>.map&nbsp;xml_of_file&nbsp;l)<br>
<br>
<span class="keyword">let</span>&nbsp;file_of_xml&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_xml</span>.<span class="constructor">E</span>&nbsp;(((<span class="string">""</span>,<span class="string">"file"</span>),&nbsp;atts),&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">List</span>.partition&nbsp;(<span class="keyword">fun</span>&nbsp;((_,s),_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s&nbsp;=&nbsp;<span class="string">"file"</span>)&nbsp;atts&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((_,filename)&nbsp;::&nbsp;_),&nbsp;others&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(filename,&nbsp;<span class="constructor">List</span>.map&nbsp;(<span class="keyword">fun</span>&nbsp;((_,s),v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(s,&nbsp;v))&nbsp;others)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<br>
<span class="keyword">let</span>&nbsp;file_list_of_xml&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_xml</span>.<span class="constructor">E</span>&nbsp;(((<span class="string">""</span>,<span class="string">"list"</span>),&nbsp;_),&nbsp;l)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.rev<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.fold_left<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;acc&nbsp;xml&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;file_of_xml&nbsp;xml&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;acc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;::&nbsp;acc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
<br>
<span class="keyword">let</span>&nbsp;read_open_buffers_file&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Ed_xml</span>.read_xml_file&nbsp;~strip:&nbsp;<span class="keyword">true</span>&nbsp;f&nbsp;file_list_of_xml<br>
<br>
<span class="keyword">let</span>&nbsp;write_open_buffers_file&nbsp;file&nbsp;buffers&nbsp;&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;xml&nbsp;=&nbsp;xml_of_file_list&nbsp;buffers&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s&nbsp;=&nbsp;<span class="constructor">Ed_xml</span>.string_of_xml&nbsp;xml&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_extern</span>.file_of_string&nbsp;~file&nbsp;s<br>
;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Recentlyusedbuffers">Recently used buffers</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;buffer_name_history&nbsp;=&nbsp;ref&nbsp;[]<br>
<span class="keyword">let</span>&nbsp;remove_buffer_from_history&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;buffer_name_history&nbsp;:=&nbsp;<span class="constructor">List</span>.filter&nbsp;((&lt;&gt;)&nbsp;name)&nbsp;!buffer_name_history<br>
<span class="keyword">let</span>&nbsp;make_buffer_first_in_history&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;remove_buffer_from_history&nbsp;name;<br>
&nbsp;&nbsp;buffer_name_history&nbsp;:=&nbsp;name&nbsp;::&nbsp;!buffer_name_history<br>
;;<br>
<span class="keyword">let</span>&nbsp;rename_buffer_in_history&nbsp;oldname&nbsp;newname&nbsp;=<br>
&nbsp;&nbsp;buffer_name_history&nbsp;:=&nbsp;<span class="constructor">List</span>.map<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;s&nbsp;=&nbsp;oldname&nbsp;<span class="keyword">then</span>&nbsp;newname&nbsp;<span class="keyword">else</span>&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;!buffer_name_history<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Thehistoryofpastabletext">The history of pastable text</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;pastable_history&nbsp;=&nbsp;<span class="constructor">Ed_minibuffer</span>.history&nbsp;()<br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** <h2 id="2_ThebufferusingGtkSourceViewsourcebuffer">The buffer, using GtkSourceView.source_buffer</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">class</span>&nbsp;my_buffer&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;buffer&nbsp;=&nbsp;<span class="constructor">GSourceView2</span>.source_buffer&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">object</span>(self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">inherit</span>&nbsp;<span class="constructor">GSourceView2</span>.source_buffer&nbsp;buffer<span class="keywordsign">#</span>as_source_buffer<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;<span class="keyword">private</span>&nbsp;filter_out_sig&nbsp;view_id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;iter&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(vid,sid)&nbsp;::&nbsp;q&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;vid&nbsp;=&nbsp;view_id&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">GtkSignal</span>.disconnect&nbsp;buffer<span class="keywordsign">#</span>as_source_buffer&nbsp;sid;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(vid,sid)&nbsp;::&nbsp;(iter&nbsp;q)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;modified_changed_signal_ids&nbsp;:&nbsp;(int&nbsp;*&nbsp;<span class="constructor">GtkSignal</span>.id)&nbsp;list&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;remove_modified_changed&nbsp;view_id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modified_changed_signal_ids&nbsp;&lt;-&nbsp;self<span class="keywordsign">#</span>filter_out_sig&nbsp;view_id&nbsp;modified_changed_signal_ids<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;connect_modified_changed&nbsp;view_id&nbsp;cb&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>remove_modified_changed&nbsp;view_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sid&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>modified_changed&nbsp;cb&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modified_changed_signal_ids&nbsp;&lt;-&nbsp;(view_id,&nbsp;sid)&nbsp;::&nbsp;modified_changed_signal_ids<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;cursor_moved_signal_ids&nbsp;:&nbsp;(int&nbsp;*&nbsp;<span class="constructor">GtkSignal</span>.id)&nbsp;list&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;remove_cursor_moved&nbsp;view_id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cursor_moved_signal_ids&nbsp;&lt;-&nbsp;self<span class="keywordsign">#</span>filter_out_sig&nbsp;view_id&nbsp;cursor_moved_signal_ids<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;connect_cursor_moved&nbsp;view_id&nbsp;cb&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>remove_cursor_moved&nbsp;view_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sid&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>mark_set<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;it&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">if</span>&nbsp;it<span class="keywordsign">#</span>equal&nbsp;(buffer<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>)&nbsp;<span class="keyword">then</span>&nbsp;cb&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cursor_moved_signal_ids&nbsp;&lt;-&nbsp;(view_id,&nbsp;sid)&nbsp;::&nbsp;cursor_moved_signal_ids<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;insert_text_signal_ids&nbsp;:&nbsp;(int&nbsp;*&nbsp;<span class="constructor">GtkSignal</span>.id)&nbsp;list&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;remove_insert_text&nbsp;view_id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_text_signal_ids&nbsp;&lt;-&nbsp;self<span class="keywordsign">#</span>filter_out_sig&nbsp;view_id&nbsp;insert_text_signal_ids<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;connect_insert_text&nbsp;view_id&nbsp;cb&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>remove_insert_text&nbsp;view_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sid&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>insert_text&nbsp;cb&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert_text_signal_ids&nbsp;&lt;-&nbsp;(view_id,&nbsp;sid)&nbsp;::&nbsp;insert_text_signal_ids<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;delete_range_signal_ids&nbsp;:&nbsp;(int&nbsp;*&nbsp;<span class="constructor">GtkSignal</span>.id)&nbsp;list&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;remove_delete_range&nbsp;view_id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete_range_signal_ids&nbsp;&lt;-&nbsp;self<span class="keywordsign">#</span>filter_out_sig&nbsp;view_id&nbsp;delete_range_signal_ids<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;connect_delete_range&nbsp;view_id&nbsp;cb&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>remove_delete_range&nbsp;view_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sid&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>delete_range&nbsp;cb&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete_range_signal_ids&nbsp;&lt;-&nbsp;(view_id,&nbsp;sid)&nbsp;::&nbsp;delete_range_signal_ids<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;remove_view_callbacks&nbsp;view_id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>remove_modified_changed&nbsp;view_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>remove_cursor_moved&nbsp;view_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>remove_insert_text&nbsp;view_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>remove_delete_range&nbsp;view_id<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_syntax_mode&nbsp;lang&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>set_language&nbsp;lang<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;syntax_mode&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>language<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;<span class="keyword">private</span>&nbsp;pcre_offset_tuple_to_char_indices&nbsp;text&nbsp;(start,stop)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;len1&nbsp;=&nbsp;<span class="constructor">Ed_utf8</span>.utf8_string_length&nbsp;(<span class="constructor">String</span>.sub&nbsp;text&nbsp;0&nbsp;start)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(len1,&nbsp;len1&nbsp;+&nbsp;<span class="constructor">Ed_utf8</span>.utf8_string_length&nbsp;(<span class="constructor">String</span>.sub&nbsp;text&nbsp;start&nbsp;(stop-start)))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;<span class="keyword">private</span>&nbsp;re_search_backward&nbsp;re&nbsp;text&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Pcre</span>.exec_all&nbsp;~rex:&nbsp;re&nbsp;text&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;len&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;res&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;len&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Pcre</span>.get_substring_ofs&nbsp;res.(len-1)&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Invalid_argument</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">Not_found</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;<span class="constructor">Not_found</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;<span class="keyword">private</span>&nbsp;re_search_forward&nbsp;re&nbsp;text&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;res&nbsp;=&nbsp;<span class="constructor">Pcre</span>.exec&nbsp;~rex:&nbsp;re&nbsp;text&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Pcre</span>.get_substring_ofs&nbsp;res&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Invalid_argument</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;raise&nbsp;<span class="constructor">Not_found</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;re_search&nbsp;forward&nbsp;?(start=buffer<span class="keywordsign">#</span>start_iter)&nbsp;?(stop=buffer<span class="keywordsign">#</span>end_iter)&nbsp;re&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;warning:&nbsp;if&nbsp;we&nbsp;search&nbsp;backward,&nbsp;we&nbsp;must&nbsp;start&nbsp;on&nbsp;charcrater&nbsp;back&nbsp;that&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;one&nbsp;indicated,&nbsp;because&nbsp;Str&nbsp;starts&nbsp;with&nbsp;the&nbsp;given&nbsp;start&nbsp;position,&nbsp;not&nbsp;before&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start&nbsp;position;&nbsp;that&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;[GSourceView2.iter_backward_search]&nbsp;function<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;the&nbsp;way&nbsp;gtk&nbsp;handles&nbsp;this&nbsp;in&nbsp;general,&nbsp;so&nbsp;we&nbsp;make&nbsp;this&nbsp;hack&nbsp;to&nbsp;act&nbsp;the&nbsp;same&nbsp;way.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(text)&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_text&nbsp;~start&nbsp;~stop&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;forward&nbsp;<span class="keyword">then</span>&nbsp;self<span class="keywordsign">#</span>re_search_forward&nbsp;<span class="keyword">else</span>&nbsp;self<span class="keywordsign">#</span>re_search_backward&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;offset&nbsp;=&nbsp;start<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"offset=%d"&nbsp;offset);<br>
*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(char_start,&nbsp;char_end)&nbsp;=&nbsp;self<span class="keywordsign">#</span>pcre_offset_tuple_to_char_indices&nbsp;text&nbsp;(f&nbsp;re&nbsp;text)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(char_start,&nbsp;char_end)&nbsp;=&nbsp;(char_start&nbsp;+&nbsp;offset,&nbsp;char_end&nbsp;+&nbsp;offset)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"found:&nbsp;start=%d&nbsp;end=%d"&nbsp;char_start&nbsp;char_end);*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;start&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;char_start)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stop&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;char_end)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(start,&nbsp;stop)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;get_iter&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">LINECHAR</span>&nbsp;(l,c)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;line&nbsp;=&nbsp;max&nbsp;0&nbsp;(min&nbsp;(buffer<span class="keywordsign">#</span>line_count&nbsp;-&nbsp;1)&nbsp;l)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it1&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">LINECHAR</span>&nbsp;(line,0))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;chars&nbsp;=&nbsp;it1<span class="keywordsign">#</span>chars_in_line&nbsp;-<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;line&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>line_count&nbsp;-&nbsp;1&nbsp;<span class="keyword">then</span>&nbsp;0&nbsp;<span class="keyword">else</span>&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;c&nbsp;=&nbsp;max&nbsp;0&nbsp;(min&nbsp;c&nbsp;chars)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">LINECHAR</span>&nbsp;(line,c))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;loc&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;loc<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Modes">Modes</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">class</span>&nbsp;<span class="keyword">type</span>&nbsp;mode&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;name&nbsp;:&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;key_bindings&nbsp;:&nbsp;(<span class="constructor">Okey</span>.keyhit_state&nbsp;*&nbsp;string)&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;menus&nbsp;:&nbsp;(string&nbsp;*&nbsp;<span class="constructor">GToolbox</span>.menu_entry&nbsp;list)&nbsp;list<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;to_display&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;from_display&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_to_display&nbsp;:&nbsp;(string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_from_display&nbsp;:&nbsp;(string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;word_re&nbsp;:&nbsp;string<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">class</span>&nbsp;empty_mode&nbsp;:&nbsp;mode&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;to_display&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;from_display&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;name&nbsp;=&nbsp;<span class="string">"empty&nbsp;mode"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;key_bindings&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;menus&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;to_display&nbsp;s&nbsp;=&nbsp;to_display&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;from_display&nbsp;s&nbsp;=&nbsp;from_display&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_to_display&nbsp;f&nbsp;=&nbsp;to_display&nbsp;&lt;-&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_from_display&nbsp;f&nbsp;=&nbsp;from_display&nbsp;&lt;-&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;word_re&nbsp;=&nbsp;<span class="string">"[a-zA-Z0-9]+"</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;available_modes&nbsp;=&nbsp;<span class="constructor">Hashtbl</span>.create&nbsp;37<br>
<span class="keyword">let</span>&nbsp;register_mode&nbsp;?(replace=<span class="keyword">false</span>)&nbsp;m&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;ignore(<span class="constructor">Hashtbl</span>.find&nbsp;available_modes&nbsp;m<span class="keywordsign">#</span>name);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;replace&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.replace&nbsp;available_modes&nbsp;m<span class="keywordsign">#</span>name&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Mode&nbsp;%s&nbsp;already&nbsp;registered."</span>&nbsp;m<span class="keywordsign">#</span>name)<br>
&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.add&nbsp;available_modes&nbsp;m<span class="keywordsign">#</span>name&nbsp;m<br>
<br>
<span class="keyword">let</span>&nbsp;get_mode&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Hashtbl</span>.find&nbsp;available_modes&nbsp;name<br>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Mode&nbsp;%s&nbsp;unknown."</span>&nbsp;name)<br>
<br>
<span class="keyword">let</span>&nbsp;available_mode_names&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.fold&nbsp;(<span class="keyword">fun</span>&nbsp;name&nbsp;_&nbsp;acc&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;name&nbsp;::&nbsp;acc)&nbsp;available_modes&nbsp;[]<br>
;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Associatingbufferedfilesandmodes">Associating <code class="code">buffered_files</code> and <code class="code">modes</code></h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;mode_name_of_filename&nbsp;filename&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(_,mode_name)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(re,_)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;re&nbsp;=&nbsp;<span class="constructor">Str</span>.regexp&nbsp;re&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Str</span>.string_match&nbsp;re&nbsp;filename&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_sourceview_rc</span>.filename_mode_patterns<span class="keywordsign">#</span>get<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;mode_name<br>
&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
<br>
<span class="keyword">let</span>&nbsp;mode_of_filename&nbsp;file&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;mode_name_of_filename&nbsp;file&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;name&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Some</span>&nbsp;(get_mode&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.error_message&nbsp;s;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Abufferassociatedtoafile">A buffer associated to a file</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">exception</span>&nbsp;<span class="constructor">Newer_file_exists</span>&nbsp;<span class="keyword">of</span>&nbsp;string<br>
<br>
<span class="keyword">class</span>&nbsp;buffered_file&nbsp;?(attributes=[])&nbsp;?loc&nbsp;~name&nbsp;~filename&nbsp;buffer&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;loc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;loc&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;get_att&nbsp;<span class="string">"location"</span>&nbsp;attributes&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(0,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;line_char_of_location&nbsp;buffer&nbsp;(location_of_string&nbsp;s)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;enc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;get_att&nbsp;<span class="string">"encoding"</span>&nbsp;attributes&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="constructor">Ed_core_rc</span>.encoding<span class="keywordsign">#</span>get<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;s<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;get_att&nbsp;<span class="string">"mode"</span>&nbsp;attributes&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mode_of_filename&nbsp;filename<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;(get_mode&nbsp;m)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Failure</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.error_message&nbsp;s;&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stxmode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;get_att&nbsp;<span class="string">"stxmode"</span>&nbsp;attributes&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;lang_of_filename&nbsp;filename<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Gtksv_utils</span>.source_language_by_name&nbsp;s<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">object</span>(self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;name&nbsp;:&nbsp;string&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;name&nbsp;=&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_name&nbsp;s&nbsp;=&nbsp;name&nbsp;&lt;-&nbsp;s<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;filename&nbsp;:&nbsp;string&nbsp;=&nbsp;filename<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;filename&nbsp;=&nbsp;filename<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_filename&nbsp;f&nbsp;=&nbsp;filename&nbsp;&lt;-&nbsp;f<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;source_marks&nbsp;=&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;source_marks&nbsp;=&nbsp;source_marks<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_source_marks&nbsp;l&nbsp;=&nbsp;source_marks&nbsp;&lt;-&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;add_source_mark&nbsp;sm&nbsp;=&nbsp;source_marks&nbsp;&lt;-&nbsp;sm&nbsp;::&nbsp;source_marks<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;update_source_marks&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bookmarks&nbsp;=&nbsp;<span class="constructor">List</span>.filter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(bm_name,&nbsp;(f,_,_))&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.safe_same_files&nbsp;filename&nbsp;f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Ed_bookmarks</span>.list&nbsp;bookmarks)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer<span class="keywordsign">#</span>remove_source_marks<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~start:&nbsp;buffer<span class="keywordsign">#</span>start_iter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~stop:&nbsp;buffer<span class="keywordsign">#</span>end_iter&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(bm,(_,l,c))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"adding&nbsp;bookmark&nbsp;%s&nbsp;on&nbsp;file&nbsp;%s&nbsp;at&nbsp;line&nbsp;%d&nbsp;and&nbsp;char&nbsp;%d"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bm&nbsp;filename&nbsp;l&nbsp;c);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sm&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>create_source_mark&nbsp;~name:&nbsp;bm&nbsp;~category:&nbsp;<span class="string">"bookmark"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">LINECHAR</span>&nbsp;(l,c)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>add_source_mark&nbsp;(bm,&nbsp;sm)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bookmarks<br>
<br>
<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;method&nbsp;private&nbsp;update_source_marks_in_bookmarks&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List.iter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fun&nbsp;(name,&nbsp;sm)&nbsp;-&gt;&nbsp;Ed_bookmarks.remove&nbsp;bookmarks&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self#source_marks;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;f&nbsp;(name,&nbsp;sm)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;it&nbsp;=&nbsp;buffer#get_iter_at_mark&nbsp;sm#coerce&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;sm#get_line&nbsp;&gt;&nbsp;0&nbsp;then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;bm&nbsp;=&nbsp;(filename,&nbsp;it#line,&nbsp;it#line_index)&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ed_bookmarks.set&nbsp;bookmarks&nbsp;name&nbsp;bm<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;markers&nbsp;=&nbsp;buffer#get_markers_in_region<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~start:&nbsp;buffer#start_iter&nbsp;~stop:&nbsp;buffer#end_iter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List.iter&nbsp;f&nbsp;markers;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;store_bookmarks();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List.iter&nbsp;buffer#delete_marker&nbsp;self#source_marks;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self#set_source_marks&nbsp;[];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self#update_source_marks<br>
*)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;buffer&nbsp;:&nbsp;my_buffer&nbsp;=&nbsp;buffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;buffer&nbsp;=&nbsp;buffer<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;attributes&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="string">"location"</span>,&nbsp;string_of_line_char&nbsp;self<span class="keywordsign">#</span>location&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"encoding"</span>,&nbsp;(<span class="keyword">match</span>&nbsp;self<span class="keywordsign">#</span>encoding&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"mode"</span>,&nbsp;(<span class="keyword">match</span>&nbsp;self<span class="keywordsign">#</span>mode&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<span class="keywordsign">#</span>name)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"stxmode"</span>,&nbsp;(<span class="keyword">match</span>&nbsp;self<span class="keywordsign">#</span>syntax_mode&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<span class="keywordsign">#</span>name)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;date&nbsp;=&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;date&nbsp;=&nbsp;date<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_date&nbsp;d&nbsp;=&nbsp;date&nbsp;&lt;-&nbsp;d<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;location&nbsp;=&nbsp;loc<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;location&nbsp;=&nbsp;location<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_location&nbsp;(l,c)&nbsp;=&nbsp;location&nbsp;&lt;-&nbsp;(l,c)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;encoding&nbsp;:&nbsp;string&nbsp;option&nbsp;=&nbsp;enc<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;encoding&nbsp;=&nbsp;encoding<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_encoding&nbsp;e&nbsp;=&nbsp;encoding&nbsp;&lt;-&nbsp;e<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;of_utf8&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;encoding&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.of_utf8&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;coding&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.of_utf8&nbsp;~coding&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;to_utf8&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;encoding&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.to_utf8&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;coding&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.to_utf8&nbsp;~coding&nbsp;s<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;mode&nbsp;=&nbsp;(mode&nbsp;:&nbsp;mode&nbsp;option)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;mode&nbsp;=&nbsp;mode<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_mode&nbsp;m&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mode&nbsp;&lt;-&nbsp;m<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;m2&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s&nbsp;=&nbsp;m2<span class="keywordsign">#</span>from_display&nbsp;(self<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>get_text&nbsp;())&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mode&nbsp;&lt;-&nbsp;m;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>set_text&nbsp;(self<span class="keywordsign">#</span>mode_to_display&nbsp;s);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>set_modified&nbsp;<span class="keyword">false</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;mode_key_bindings&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<span class="keywordsign">#</span>key_bindings<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;mode_menus&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<span class="keywordsign">#</span>menus<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;mode_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;m<span class="keywordsign">#</span>name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_syntax_mode&nbsp;lang&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>set_syntax_mode&nbsp;lang<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;syntax_mode&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>syntax_mode<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;mode_from_display&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<span class="keywordsign">#</span>from_display&nbsp;s<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;mode_to_display&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;mode&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;m&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;m<span class="keywordsign">#</span>to_display&nbsp;s<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;load_file&nbsp;filename&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Sys</span>.file_exists&nbsp;filename&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FIXME:&nbsp;handle&nbsp;errors&nbsp;occuring&nbsp;while&nbsp;opening&nbsp;file&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;text&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;self<span class="keywordsign">#</span>mode_to_display<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(self<span class="keywordsign">#</span>to_utf8&nbsp;(<span class="constructor">Ed_extern</span>.string_of_file&nbsp;filename))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>begin_not_undoable_action&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>set_text&nbsp;text;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>end_not_undoable_action&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>set_modified&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>update_date;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>update_source_marks<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;newer_file_exists&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;d&nbsp;=&nbsp;<span class="constructor">Ed_misc</span>.mod_date_of_file&nbsp;filename&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;date&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;d2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;d2&nbsp;&lt;&nbsp;d<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;write_file&nbsp;?(fail_if_newer=<span class="keyword">false</span>)&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;self<span class="keywordsign">#</span>newer_file_exists&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;fail_if_newer&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;(<span class="constructor">Newer_file_exists</span>&nbsp;filename);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;utf8&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_text&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s&nbsp;=&nbsp;self<span class="keywordsign">#</span>of_utf8&nbsp;(self<span class="keywordsign">#</span>mode_from_display&nbsp;utf8)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_extern</span>.file_of_string&nbsp;~file:&nbsp;filename&nbsp;s;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer<span class="keywordsign">#</span>set_modified&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>update_date<br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self#update_source_marks_in_bookmarks*)</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;update_date&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;&lt;-&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Ed_misc</span>.mod_date_of_file&nbsp;filename)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;select_location&nbsp;loc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(l,c)&nbsp;=&nbsp;line_char_of_location&nbsp;buffer&nbsp;(<span class="constructor">Some</span>&nbsp;loc)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;(l,c);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer<span class="keywordsign">#</span>place_cursor&nbsp;~where:&nbsp;(buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">LINECHAR</span>&nbsp;(l,c)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(start,stop)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;loc&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Linechar</span>&nbsp;(l,c)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;n&nbsp;=&nbsp;(buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">LINECHAR</span>&nbsp;(l,c)))<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(n,&nbsp;n)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Linechars</span>&nbsp;(l,(start,stop))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">LINECHAR</span>&nbsp;(l,c))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;start2&nbsp;=&nbsp;it<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stop&nbsp;=&nbsp;(it<span class="keywordsign">#</span>forward_cursor_positions&nbsp;(stop-start))<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(start2,&nbsp;stop)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Chars</span>&nbsp;(start,stop)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(start,stop)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Char</span>&nbsp;start&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(start,start)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer<span class="keywordsign">#</span>select_range<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;start))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;stop))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;range_from_range_in_file&nbsp;~left&nbsp;~right&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from_display&nbsp;=&nbsp;self<span class="keywordsign">#</span>mode_from_display&nbsp;(buffer<span class="keywordsign">#</span>get_text&nbsp;())&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(left,&nbsp;right)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;left&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_utf8</span>.utf8_string_length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(self<span class="keywordsign">#</span>mode_to_display<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.sub&nbsp;from_display&nbsp;0&nbsp;left))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;right&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_utf8</span>.utf8_string_length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(self<span class="keywordsign">#</span>mode_to_display<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.sub&nbsp;from_display&nbsp;0&nbsp;right))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(left,&nbsp;right)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(left,&nbsp;right)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;line_offset_from_line_in_file&nbsp;line&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;char_offset&nbsp;=&nbsp;<span class="constructor">Ed_misc</span>.char_of_line&nbsp;filename&nbsp;line&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from_display&nbsp;=&nbsp;self<span class="keywordsign">#</span>mode_from_display&nbsp;(buffer<span class="keywordsign">#</span>get_text&nbsp;())&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_utf8</span>.utf8_string_length<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(self<span class="keywordsign">#</span>mode_to_display&nbsp;(<span class="constructor">String</span>.sub&nbsp;from_display&nbsp;0&nbsp;char_offset))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;select_range_in_file&nbsp;~left&nbsp;~right&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(left,&nbsp;right)&nbsp;=&nbsp;self<span class="keywordsign">#</span>range_from_range_in_file&nbsp;~left&nbsp;~right&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;start&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;left)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stop&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;right)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer<span class="keywordsign">#</span>select_range&nbsp;start&nbsp;stop<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">initializer</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_syntax_mode&nbsp;stxmode;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>load_file&nbsp;filename;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;on_marker_update&nbsp;iter&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;<span class="string">"marker_update"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(bm,&nbsp;m)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>get_iter_at_mark&nbsp;m<span class="keywordsign">#</span>coerce&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"marker&nbsp;%s&nbsp;on&nbsp;line&nbsp;%d"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bm&nbsp;it<span class="keywordsign">#</span>line<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>source_marks<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(buffer<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>source_mark_updated&nbsp;on_marker_update);<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Theviews">The views</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">class</span>&nbsp;sourceview&nbsp;?(attributes=[])&nbsp;(topwin&nbsp;:&nbsp;<span class="constructor">Ed_view</span>.topwin)<br>
&nbsp;&nbsp;f_on_destroy&nbsp;f_set_active&nbsp;f_dup<br>
&nbsp;&nbsp;(f_file_rename&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit)&nbsp;(file&nbsp;:&nbsp;buffered_file)&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vbox&nbsp;=&nbsp;<span class="constructor">GPack</span>.vbox&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wscroll&nbsp;=&nbsp;<span class="constructor">GBin</span>.scrolled_window<br>
&nbsp;&nbsp;&nbsp;&nbsp;~packing:&nbsp;(vbox<span class="keywordsign">#</span>pack&nbsp;~expand:&nbsp;<span class="keyword">true</span>&nbsp;~fill:&nbsp;<span class="keyword">true</span>&nbsp;~padding:&nbsp;0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~border_width:&nbsp;0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~vpolicy:&nbsp;<span class="keywordsign">`</span><span class="constructor">AUTOMATIC</span>&nbsp;~hpolicy:&nbsp;<span class="keywordsign">`</span><span class="constructor">AUTOMATIC</span>&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;show_line_numbers&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;get_att_f&nbsp;<span class="constructor">Ed_misc</span>.bool_of_string&nbsp;<span class="string">"line_numbers"</span>&nbsp;attributes&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;show_line_marks&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;get_att_f&nbsp;<span class="constructor">Ed_misc</span>.bool_of_string&nbsp;<span class="string">"line_markers"</span>&nbsp;attributes&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wrap_mode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;get_att_f&nbsp;~default:&nbsp;<span class="constructor">Ed_sourceview_rc</span>.default_wrap_mode<span class="keywordsign">#</span>get<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_sourceview_rc</span>.wrap_mode_of_string&nbsp;<span class="string">"wrap_mode"</span>&nbsp;attributes<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;source_view&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">GSourceView2</span>.source_view<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~source_buffer:&nbsp;(file<span class="keywordsign">#</span>buffer&nbsp;:&gt;&nbsp;<span class="constructor">GSourceView2</span>.source_buffer)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~editable:&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~auto_indent:<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~insert_spaces_instead_of_tabs:<span class="keyword">true</span>&nbsp;~tab_width:2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~show_line_numbers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~show_line_marks<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?wrap_mode<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~smart_home_end:&nbsp;<span class="keywordsign">`</span><span class="constructor">ALWAYS</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~packing:&nbsp;wscroll<span class="keywordsign">#</span>add<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hbox_state&nbsp;=&nbsp;<span class="constructor">GPack</span>.hbox&nbsp;~packing:&nbsp;vbox<span class="keywordsign">#</span>pack&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;add_state&nbsp;fopt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;evbox&nbsp;=&nbsp;<span class="constructor">GBin</span>.event_box&nbsp;~packing:&nbsp;hbox_state<span class="keywordsign">#</span>pack&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wl&nbsp;=&nbsp;<span class="constructor">GMisc</span>.label&nbsp;~packing:&nbsp;evbox<span class="keywordsign">#</span>add&nbsp;~xpad:&nbsp;5&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fopt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(evbox<span class="keywordsign">#</span>event<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>button_press<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;ev&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">GdkEvent</span>.get_type&nbsp;ev&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">BUTTON_PRESS</span>&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">GdkEvent</span>.<span class="constructor">Button</span>.button&nbsp;ev&nbsp;=&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;();&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;wl<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;on_stx_click&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(factory_name^<span class="string">"_popup_syntax_mode_choice"</span>)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;on_mode_click&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(factory_name^<span class="string">"_popup_mode_choice"</span>)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wl_modified&nbsp;=&nbsp;add_state&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wl_file&nbsp;=&nbsp;add_state&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wl_loc&nbsp;=&nbsp;add_state&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wl_stx_mode&nbsp;=&nbsp;add_state&nbsp;(<span class="constructor">Some</span>&nbsp;on_stx_click)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wl_mode&nbsp;=&nbsp;add_state&nbsp;(<span class="constructor">Some</span>&nbsp;on_mode_click)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wl_encoding&nbsp;=&nbsp;add_state&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ref_on_destroy&nbsp;=&nbsp;ref&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;())&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">object</span>(self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">inherit</span>&nbsp;<span class="constructor">Ed_view</span>.dyn_label<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">inherit</span>&nbsp;<span class="constructor">Ed_view</span>.dyn_destroyable<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;!ref_on_destroy&nbsp;()&nbsp;;&nbsp;source_view<span class="keywordsign">#</span>destroy&nbsp;();vbox<span class="keywordsign">#</span>destroy();)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;minibuffer&nbsp;=&nbsp;topwin<span class="keywordsign">#</span>minibuffer<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;file&nbsp;=&nbsp;file<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;source_view&nbsp;=&nbsp;source_view<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;source_buffer&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;box&nbsp;=&nbsp;vbox<span class="keywordsign">#</span>coerce<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;<span class="keyword">private</span>&nbsp;write_file&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;do_write&nbsp;~fail_if_newer&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>write_file&nbsp;~fail_if_newer&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;msg&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Wrote&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(utf8_of_filename&nbsp;~full:&nbsp;<span class="keyword">true</span>&nbsp;file<span class="keywordsign">#</span>filename)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.display_message&nbsp;msg<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Newer_file_exists</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;do_it&nbsp;()&nbsp;=&nbsp;do_write&nbsp;~fail_if_newer:&nbsp;<span class="keyword">false</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.confirm&nbsp;self<span class="keywordsign">#</span>minibuffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s&nbsp;was&nbsp;edited&nbsp;since&nbsp;last&nbsp;visited;&nbsp;write&nbsp;anyway&nbsp;?"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(utf8_of_filename&nbsp;~full:&nbsp;<span class="keyword">true</span>&nbsp;file<span class="keywordsign">#</span>filename))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do_it<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Failure</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Sys_error</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Glib</span>.<span class="constructor">Convert</span>.<span class="constructor">Error</span>&nbsp;(_,s)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.error_message&nbsp;(<span class="constructor">Ed_misc</span>.to_utf8&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do_write&nbsp;~fail_if_newer:&nbsp;<span class="keyword">true</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;do_save&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>write_file<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;save&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;self<span class="keywordsign">#</span>buffer_modified&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>do_save<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.set_active_action_message&nbsp;<span class="string">"(No&nbsp;changes&nbsp;need&nbsp;to&nbsp;be&nbsp;saved)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;save_as&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;save&nbsp;newname&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;do_it&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_file_rename&nbsp;file<span class="keywordsign">#</span>filename&nbsp;newname;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>write_file&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Failure</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.error_message&nbsp;(<span class="constructor">Ed_misc</span>.to_utf8&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Sys</span>.file_exists&nbsp;newname&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.confirm&nbsp;self<span class="keywordsign">#</span>minibuffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Overwrite&nbsp;%s&nbsp;?"</span>&nbsp;(utf8_of_filename&nbsp;~full:&nbsp;<span class="keyword">true</span>&nbsp;newname))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do_it<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do_it&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.select_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>minibuffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~title:&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Save&nbsp;%s&nbsp;as&nbsp;..."</span>&nbsp;(utf8_of_filename&nbsp;file<span class="keywordsign">#</span>filename))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="constructor">Filename</span>.dirname&nbsp;file<span class="keywordsign">#</span>filename)^<span class="string">"/"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;save<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;f<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;paste&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(factory_name^<span class="string">"_paste"</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;copy&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(factory_name^<span class="string">"_copy"</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;cut&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(factory_name^<span class="string">"_cut"</span>))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;close&nbsp;=&nbsp;vbox<span class="keywordsign">#</span>destroy&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;kind&nbsp;=&nbsp;factory_name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;my_location&nbsp;=&nbsp;(0,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_my_location&nbsp;(l,c)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"set_my_location(%d,%d)"&nbsp;l&nbsp;c);*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my_location&nbsp;&lt;-&nbsp;(l,c);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>set_location&nbsp;(l,c);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_location<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;attributes&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="string">"location"</span>,&nbsp;string_of_line_char&nbsp;my_location&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"line_numbers"</span>,&nbsp;(<span class="constructor">Ed_misc</span>.string_of_bool&nbsp;source_view<span class="keywordsign">#</span>show_line_numbers)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"line_markers"</span>,&nbsp;(<span class="constructor">Ed_misc</span>.string_of_bool&nbsp;source_view<span class="keywordsign">#</span>show_line_marks)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"wrap_mode"</span>,&nbsp;(<span class="constructor">Ed_sourceview_rc</span>.string_of_wrap_mode&nbsp;source_view<span class="keywordsign">#</span>wrap_mode)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;file&nbsp;=&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;filename&nbsp;=&nbsp;file<span class="keywordsign">#</span>filename<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;buffer_name&nbsp;=&nbsp;file<span class="keywordsign">#</span>name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;buffer_modified&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>modified<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_location&nbsp;(l,c)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"set_location(%d,%d)"&nbsp;l&nbsp;c);*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;to&nbsp;avoid&nbsp;a&nbsp;fatal&nbsp;gtk&nbsp;error&nbsp;if&nbsp;the&nbsp;offset&nbsp;on&nbsp;line&nbsp;is&nbsp;bigger&nbsp;than<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;maximum&nbsp;offset&nbsp;of&nbsp;the&nbsp;line,&nbsp;we&nbsp;minimize&nbsp;the&nbsp;column&nbsp;by<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(the&nbsp;number&nbsp;of&nbsp;chars&nbsp;on&nbsp;the&nbsp;line)&nbsp;-&nbsp;1.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;current_loc&nbsp;=&nbsp;self<span class="keywordsign">#</span>location_in_buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;current_loc&nbsp;=&nbsp;(l,c)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"current_loc&nbsp;=&nbsp;(l,c)");*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>update_my_location<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">LINECHAR</span>&nbsp;(l,c))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;it<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>scroll_to_mark&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;select_location&nbsp;loc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;(line_char_of_location&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;(<span class="constructor">Some</span>&nbsp;loc));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>select_location&nbsp;loc<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;select_location_opt&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;loc&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;self<span class="keywordsign">#</span>select_location&nbsp;loc<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;has_focus&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;source_view<span class="keywordsign">#</span>misc<span class="keywordsign">#</span>get_flag&nbsp;<span class="keywordsign">`</span><span class="constructor">HAS_FOCUS</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;b&nbsp;then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"view&nbsp;%d:&nbsp;I&nbsp;have&nbsp;the&nbsp;focus!"&nbsp;(Oo.id&nbsp;self));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;location_in_buffer&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iter&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location_of_iter&nbsp;iter<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;current_line&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fst&nbsp;self<span class="keywordsign">#</span>location_in_buffer<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;update_my_location&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_my_location&nbsp;self<span class="keywordsign">#</span>location_in_buffer<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;select_range_in_file&nbsp;?(jump:&nbsp;[<span class="keywordsign">`</span><span class="constructor">Left</span><span class="keywordsign">|</span><span class="keywordsign">`</span><span class="constructor">Right</span>]option)&nbsp;~left&nbsp;~right&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;jump&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Left</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(location_of_iter&nbsp;(file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;left)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Right</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(location_of_iter&nbsp;(file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;right)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>select_range_in_file&nbsp;~left&nbsp;~right<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;on_cursor_moved&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;self<span class="keywordsign">#</span>has_focus&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>update_my_location<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;<span class="keyword">mutable</span>&nbsp;on_focus_in&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_on_focus_in&nbsp;(f:&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_focus_in&nbsp;&lt;-<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_set_active&nbsp;self;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;my_location;&nbsp;f&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;grab_focus&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>misc<span class="keywordsign">#</span>grab_focus&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>scroll_to_mark&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f_set_active&nbsp;self;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;my_set_label&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_label&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s%s"</span>&nbsp;(utf8_of_filename&nbsp;file<span class="keywordsign">#</span>name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;source_view<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>modified&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"&nbsp;*"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span>))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_file&nbsp;?(focus_in=<span class="keyword">false</span>)&nbsp;(f&nbsp;:&nbsp;buffered_file)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>remove_view_callbacks&nbsp;(<span class="constructor">Oo</span>.id&nbsp;self);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file&nbsp;&lt;-&nbsp;f;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>set_buffer&nbsp;(f<span class="keywordsign">#</span>buffer&nbsp;:&gt;&nbsp;<span class="constructor">GText</span>.buffer);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;file<span class="keywordsign">#</span>location;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>scroll_to_mark&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>connect_buffer_events;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>my_set_label;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_state;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;focus_in&nbsp;<span class="keyword">then</span>&nbsp;on_focus_in&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;dup&nbsp;:&nbsp;<span class="constructor">Ed_view</span>.topwin&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_view</span>.gui_view&nbsp;option&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;topwin&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(f_dup&nbsp;file&nbsp;topwin)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;display_state&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_modified;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_buffer_name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_encoding&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_location&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_stx_mode&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_mode<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;display_buffer_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wl_file<span class="keywordsign">#</span>set_text&nbsp;(utf8_of_filename&nbsp;file<span class="keywordsign">#</span>name)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;display_modified&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wl_modified<span class="keywordsign">#</span>set_text&nbsp;(<span class="keyword">if</span>&nbsp;source_view<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>modified&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"*"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;display_encoding&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;enc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;file<span class="keywordsign">#</span>encoding&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"default&nbsp;encoding"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wl_encoding<span class="keywordsign">#</span>set_text&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"&nbsp;%s&nbsp;"</span>&nbsp;(<span class="constructor">Ed_misc</span>.to_utf8&nbsp;enc))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;display_location&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(line,char)&nbsp;=&nbsp;my_location&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wl_loc<span class="keywordsign">#</span>set_text&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"L%d-C%d"</span>&nbsp;(line+1)&nbsp;(char+1))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;display_stx_mode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lang&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>language&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"[no&nbsp;highlight]"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;lang&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"[%s]"</span>&nbsp;lang<span class="keywordsign">#</span>name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wl_stx_mode<span class="keywordsign">#</span>set_text&nbsp;(<span class="constructor">Ed_misc</span>.to_utf8&nbsp;lang)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;display_mode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;file<span class="keywordsign">#</span>mode_name&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"(no&nbsp;mode)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;name&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"(%s)"</span>&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wl_mode<span class="keywordsign">#</span>set_text&nbsp;(<span class="constructor">Ed_misc</span>.to_utf8&nbsp;mode)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;connect_buffer_events&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>connect_modified_changed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Oo</span>.id&nbsp;self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;self<span class="keywordsign">#</span>display_modified;&nbsp;self<span class="keywordsign">#</span>my_set_label));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>connect_cursor_moved<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Oo</span>.id&nbsp;self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;self<span class="keywordsign">#</span>on_cursor_moved));<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;key_bindings&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>mode_key_bindings&nbsp;@<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_sourceview_rc</span>.key_bindings<span class="keywordsign">#</span>get<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;bookmarks_menus&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;l&nbsp;=&nbsp;<span class="constructor">Ed_bookmarks</span>.list&nbsp;bookmarks&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;l&nbsp;=&nbsp;<span class="constructor">List</span>.sort&nbsp;(<span class="keyword">fun</span>&nbsp;(s1,_)&nbsp;(s2,_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;compare&nbsp;s1&nbsp;s2)&nbsp;l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;entries&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(name,&nbsp;(file,line,col))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"open_file&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;file));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;self<span class="keywordsign">#</span>filename&nbsp;=&nbsp;file&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;(line,col)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;label&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s&nbsp;(%s,&nbsp;%d,&nbsp;%d)"</span>&nbsp;name&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;file)&nbsp;line&nbsp;col<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(<span class="constructor">Ed_misc</span>.escape_menu_label&nbsp;(<span class="constructor">Ed_misc</span>.to_utf8&nbsp;label),&nbsp;com)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="string">"Bookmarks"</span>,&nbsp;entries]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;menus&nbsp;:&nbsp;(string&nbsp;*&nbsp;<span class="constructor">GToolbox</span>.menu_entry&nbsp;list)&nbsp;list&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;com&nbsp;()&nbsp;=&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_%s"</span>&nbsp;factory_name&nbsp;com)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FIXME:&nbsp;do&nbsp;some&nbsp;kind&nbsp;of&nbsp;merging&nbsp;between&nbsp;the&nbsp;sourceview&nbsp;menus<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;the&nbsp;mode&nbsp;menus&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Search"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(<span class="string">"Search&nbsp;forward"</span>,&nbsp;com&nbsp;<span class="string">"search"</span>)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(<span class="string">"Search&nbsp;backward"</span>,&nbsp;com&nbsp;<span class="string">"search_backward"</span>)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">S</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(<span class="string">"Search&nbsp;regexp&nbsp;forward"</span>,&nbsp;com&nbsp;<span class="string">"search_re"</span>)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(<span class="string">"Search&nbsp;regexp&nbsp;backward"</span>,&nbsp;com&nbsp;<span class="string">"search_re_backward"</span>)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">S</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(<span class="string">"Query/replace"</span>,&nbsp;com&nbsp;<span class="string">"query_replace"</span>)&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;@<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>bookmarks_menus&nbsp;@<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>mode_menus<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;update_menus&nbsp;=&nbsp;topwin<span class="keywordsign">#</span>update_menus<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;beginning_of_line&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(l,_)&nbsp;=&nbsp;location_of_iter&nbsp;it&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;(l,0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;end_of_line&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(l,_)&nbsp;=&nbsp;location_of_iter&nbsp;it&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;(l,max_int)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_scroll_on_change&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>connect_delete_range&nbsp;(<span class="constructor">Oo</span>.id&nbsp;self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;~start&nbsp;~stop&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;start);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>connect_insert_text&nbsp;(<span class="constructor">Oo</span>.id&nbsp;self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;it&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;it)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;unset_scroll_on_change&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>remove_delete_range&nbsp;(<span class="constructor">Oo</span>.id&nbsp;self);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>remove_insert_text&nbsp;(<span class="constructor">Oo</span>.id&nbsp;self)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;undo&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;b<span class="keywordsign">#</span>can_undo&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_scroll_on_change;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>undo&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>unset_scroll_on_change;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;redo&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;b<span class="keywordsign">#</span>can_redo&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_scroll_on_change;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>redo&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>unset_scroll_on_change;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;place_cursor&nbsp;?(scroll=<span class="keyword">true</span>)&nbsp;where&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>place_cursor&nbsp;~where;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;scroll&nbsp;<span class="keyword">then</span>&nbsp;ignore(source_view<span class="keywordsign">#</span>scroll_to_iter&nbsp;where);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>update_my_location<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;forward_word&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;it<span class="keywordsign">#</span>forward_word_end<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;backward_word&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;it<span class="keywordsign">#</span>backward_word_start<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;forward_line&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(l,c)&nbsp;=&nbsp;my_location&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;(l+1,c)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;backward_line&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(l,c)&nbsp;=&nbsp;my_location&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;(l-1,c)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;forward_char&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;it<span class="keywordsign">#</span>forward_cursor_position<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;backward_char&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;it<span class="keywordsign">#</span>backward_cursor_position<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;cut_to_selection&nbsp;?(concat&nbsp;:&nbsp;[<span class="keywordsign">`</span><span class="constructor">APPEND</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">PREPEND</span>]&nbsp;option)&nbsp;~start&nbsp;~stop&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;text&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_text&nbsp;~start&nbsp;~stop&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>begin_user_action&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;concat&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pastable_history<span class="keywordsign">#</span>add&nbsp;text;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">GMain</span>.selection<span class="keywordsign">#</span>set_text&nbsp;text;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sel&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">GMain</span>.selection<span class="keywordsign">#</span>text&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;text&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;p&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">PREPEND</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;text^sel<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">APPEND</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sel^text<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pastable_history<span class="keywordsign">#</span>add&nbsp;text;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">GMain</span>.selection<span class="keywordsign">#</span>set_text&nbsp;text;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>delete&nbsp;~start&nbsp;~stop;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>update_my_location;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>end_user_action&nbsp;();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;kill_line&nbsp;~append&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;eol&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;it<span class="keywordsign">#</span>ends_line&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it<span class="keywordsign">#</span>forward_line<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it<span class="keywordsign">#</span>forward_to_line_end<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;append&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">APPEND</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>cut_to_selection&nbsp;?concat&nbsp;~start:&nbsp;it&nbsp;~stop:&nbsp;eol&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;kill_word&nbsp;?concat&nbsp;forward&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(start,stop)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;forward&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(it,&nbsp;it<span class="keywordsign">#</span>forward_word_end)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(it<span class="keywordsign">#</span>backward_word_start,&nbsp;it)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>cut_to_selection&nbsp;?concat&nbsp;~start&nbsp;~stop&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;insert&nbsp;text&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>insert&nbsp;text;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>update_my_location<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;delete_char&nbsp;forward&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;start&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stop&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;forward&nbsp;<span class="keyword">then</span>&nbsp;start<span class="keywordsign">#</span>forward_char&nbsp;<span class="keyword">else</span>&nbsp;start<span class="keywordsign">#</span>backward_char<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;start<span class="keywordsign">#</span>equal&nbsp;stop&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>begin_user_action&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>delete&nbsp;~start&nbsp;~stop;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>end_user_action&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;transpose_chars&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;insert&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;insert<span class="keywordsign">#</span>is_end&nbsp;<span class="keyword">or</span>&nbsp;insert<span class="keywordsign">#</span>is_start&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stop&nbsp;=&nbsp;insert<span class="keywordsign">#</span>backward_char&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;c&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_text&nbsp;~start:&nbsp;insert&nbsp;~stop&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>begin_user_action&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>delete&nbsp;~start:&nbsp;insert&nbsp;~stop;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iter&nbsp;=&nbsp;insert<span class="keywordsign">#</span>forward_char&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>insert&nbsp;~iter&nbsp;c;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;iter;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>end_user_action&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;transpose_lines&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;insert&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;line&nbsp;=&nbsp;insert<span class="keywordsign">#</span>line&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;line&nbsp;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(line1_start,&nbsp;line1_stop)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="keyword">if</span>&nbsp;insert<span class="keywordsign">#</span>starts_line&nbsp;<span class="keyword">then</span>&nbsp;insert&nbsp;<span class="keyword">else</span>&nbsp;insert<span class="keywordsign">#</span>backward_line<span class="keywordsign">#</span>forward_line),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;insert<span class="keywordsign">#</span>is_end&nbsp;<span class="keyword">then</span>&nbsp;insert&nbsp;<span class="keyword">else</span>&nbsp;insert<span class="keywordsign">#</span>forward_line))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prevline_start&nbsp;=&nbsp;line1_start<span class="keywordsign">#</span>backward_line&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"prevline_start:%s"&nbsp;(string_of_location&nbsp;(location_of_iter&nbsp;prevline_start)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prevline_stop&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;do&nbsp;not&nbsp;cut&nbsp;the&nbsp;line&nbsp;with&nbsp;the&nbsp;ending&nbsp;'\n'&nbsp;if&nbsp;we&nbsp;are&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;buffer,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;prevent&nbsp;adding&nbsp;a&nbsp;new&nbsp;blank&nbsp;line&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;line1_stop<span class="keywordsign">#</span>is_end&nbsp;<span class="keyword">or</span>&nbsp;line1_start<span class="keywordsign">#</span>equal&nbsp;line1_stop&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prevline_start<span class="keywordsign">#</span>forward_to_line_end<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line1_start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"prevline_stop:%s"&nbsp;(string_of_location&nbsp;(location_of_iter&nbsp;prevline_stop)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prev_line&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_text&nbsp;~start:&nbsp;prevline_start&nbsp;~stop:&nbsp;prevline_stop&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prev_line&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;line1_stop<span class="keywordsign">#</span>is_end&nbsp;<span class="keyword">or</span>&nbsp;line1_start<span class="keywordsign">#</span>equal&nbsp;line1_stop&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"\n"</span>^prev_line<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prev_line<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;sline&nbsp;=&nbsp;b#get_text&nbsp;~start:&nbsp;line1_start&nbsp;~stop:&nbsp;line1_stop&nbsp;()&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"prev_line=\"%s\""&nbsp;(self#of_utf8&nbsp;prev_line));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"line=\"%s\""&nbsp;(self#of_utf8&nbsp;sline));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>begin_user_action&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;line1_stop;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>delete&nbsp;~start:&nbsp;prevline_start&nbsp;~stop:&nbsp;line1_start;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>insert&nbsp;prev_line;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>goto_line&nbsp;(line&nbsp;+&nbsp;1);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>end_user_action&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;transpose_words&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;insert&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"insert&nbsp;iter&nbsp;starts&nbsp;word:&nbsp;%b"&nbsp;insert#starts_word);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"insert&nbsp;iter&nbsp;inside&nbsp;word:&nbsp;%b"&nbsp;insert#inside_word);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"insert#forward_word_end&nbsp;is_end:&nbsp;%b"&nbsp;insert#forward_word_end#is_end);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"insert#backward_word_start&nbsp;is_start:&nbsp;%b"&nbsp;insert#backward_word_start#is_start);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;let's&nbsp;say&nbsp;we&nbsp;swap&nbsp;a&nbsp;right&nbsp;and&nbsp;left&nbsp;words&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;right_word_start&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;insert<span class="keywordsign">#</span>starts_word&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;insert<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;a&nbsp;forward_word_start&nbsp;function&nbsp;would&nbsp;have&nbsp;been&nbsp;great,&nbsp;thanks&nbsp;Gtk!&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;itend&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;insert<span class="keywordsign">#</span>inside_word&nbsp;<span class="keyword">then</span>&nbsp;insert<span class="keywordsign">#</span>forward_word_end&nbsp;<span class="keyword">else</span>&nbsp;insert<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;itend2&nbsp;=&nbsp;itend<span class="keywordsign">#</span>forward_word_end&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;itend2<span class="keywordsign">#</span>equal&nbsp;itend&nbsp;<span class="keyword">or</span>&nbsp;not&nbsp;itend2<span class="keywordsign">#</span>ends_word&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;<span class="constructor">Not_found</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itend2<span class="keywordsign">#</span>backward_word_start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;it<span class="keywordsign">#</span>is_end&nbsp;<span class="keyword">or</span>&nbsp;not&nbsp;it<span class="keywordsign">#</span>starts_word&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;<span class="constructor">Not_found</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;right_word_end&nbsp;=&nbsp;right_word_start<span class="keywordsign">#</span>forward_word_end&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;left_word_start&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;right_word_start<span class="keywordsign">#</span>backward_word_start&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;it<span class="keywordsign">#</span>equal&nbsp;right_word_start&nbsp;<span class="keyword">or</span>&nbsp;not&nbsp;it<span class="keywordsign">#</span>starts_word&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;<span class="constructor">Not_found</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;left_word_end&nbsp;=&nbsp;left_word_start<span class="keywordsign">#</span>forward_word_end&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rw_start_offset&nbsp;=&nbsp;right_word_start<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rw_end_offset&nbsp;=&nbsp;right_word_end<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rw_size&nbsp;=&nbsp;rw_end_offset&nbsp;-&nbsp;rw_start_offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lw_start_offset&nbsp;=&nbsp;left_word_start<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lw_end_offset&nbsp;=&nbsp;left_word_end<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lw_size&nbsp;=&nbsp;lw_end_offset&nbsp;-&nbsp;lw_start_offset&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rw&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_text&nbsp;~start:&nbsp;right_word_start&nbsp;~stop:&nbsp;right_word_end&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lw&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_text&nbsp;~start:&nbsp;left_word_start&nbsp;~stop:&nbsp;left_word_end&nbsp;()&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>begin_user_action&nbsp;();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>delete&nbsp;~start:&nbsp;right_word_start&nbsp;~stop:&nbsp;right_word_end;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;left_word_start&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;lw_start_offset)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;left_word_end&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;lw_end_offset)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>delete&nbsp;~start:&nbsp;left_word_start&nbsp;~stop:&nbsp;left_word_end;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iter&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;lw_start_offset)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>insert&nbsp;~iter&nbsp;rw;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;iter&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;(rw_start_offset&nbsp;-&nbsp;lw_size&nbsp;+&nbsp;rw_size))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ins_offset&nbsp;=&nbsp;iter<span class="keywordsign">#</span>offset&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>insert&nbsp;~iter&nbsp;lw;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;(b<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;(ins_offset&nbsp;+&nbsp;lw_size)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>end_user_action&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;we&nbsp;don't&nbsp;have&nbsp;two&nbsp;words&nbsp;to&nbsp;transpose&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;goto_line&nbsp;n&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;max&nbsp;0&nbsp;(min&nbsp;n&nbsp;(file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>line_count&nbsp;-&nbsp;1))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;where&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">LINE</span>&nbsp;m)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;where<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;goto_char&nbsp;n&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;max&nbsp;0&nbsp;(min&nbsp;n&nbsp;(file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>char_count&nbsp;-1))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;where&nbsp;=&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>get_iter&nbsp;(<span class="keywordsign">`</span><span class="constructor">OFFSET</span>&nbsp;m)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>place_cursor&nbsp;where<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;reload&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;g&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;()&nbsp;=&nbsp;file<span class="keywordsign">#</span>load_file&nbsp;file<span class="keywordsign">#</span>filename&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>modified&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.confirm&nbsp;self<span class="keywordsign">#</span>minibuffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Buffer&nbsp;was&nbsp;modified;&nbsp;revert&nbsp;anyway&nbsp;?"</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;g<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_syntax_mode&nbsp;lang&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>set_syntax_mode&nbsp;lang;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_stx_mode<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_mode&nbsp;mode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>set_mode&nbsp;mode;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_mode<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_encoding&nbsp;e&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file<span class="keywordsign">#</span>set_encoding&nbsp;e;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_encoding<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;switch_line_numbers&nbsp;?v&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;v&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;not&nbsp;source_view<span class="keywordsign">#</span>show_line_numbers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>set_show_line_numbers&nbsp;v<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;switch_line_markers&nbsp;?v&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;v&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;not&nbsp;source_view<span class="keywordsign">#</span>show_line_marks<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>set_show_line_marks&nbsp;v<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;set_wrap_mode&nbsp;m&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>set_wrap_mode&nbsp;m<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">initializer</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_location&nbsp;file<span class="keywordsign">#</span>location;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>set_my_location&nbsp;file<span class="keywordsign">#</span>location;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>my_set_label;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>display_state;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>scroll_to_mark&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gtksv_utils</span>.register_source_view&nbsp;source_view;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gtksv_utils</span>.apply_sourceview_props&nbsp;source_view&nbsp;(<span class="constructor">Gtksv_utils</span>.read_sourceview_props&nbsp;())&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self<span class="keywordsign">#</span>connect_buffer_events;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;add_clipboard_to_pastable_history&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">GMain</span>.clipboard<span class="keywordsign">#</span>text&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;pastable_history<span class="keywordsign">#</span>add&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(source_view<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>after<span class="keywordsign">#</span>copy_clipboard<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_clipboard_to_pastable_history);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(source_view<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>after<span class="keywordsign">#</span>cut_clipboard<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_clipboard_to_pastable_history);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(source_view<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>after<span class="keywordsign">#</span>paste_clipboard<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_clipboard_to_pastable_history);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ref_on_destroy&nbsp;:=&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f_on_destroy&nbsp;self);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(source_view<span class="keywordsign">#</span>event<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>focus_in&nbsp;(<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;on_focus_in&nbsp;();&nbsp;<span class="keyword">false</span>));<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pix_bookmark&nbsp;=&nbsp;<span class="constructor">GdkPixbuf</span>.from_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.concat&nbsp;<span class="constructor">Ed_installation</span>.pixmap_dir&nbsp;<span class="string">"bookmark.png"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;source_view<span class="keywordsign">#</span>set_mark_category_pixbuf&nbsp;<span class="string">"bookmark"</span>&nbsp;(<span class="constructor">Some</span>&nbsp;pix_bookmark)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;prerr_endline&nbsp;(<span class="constructor">Printexc</span>.to_string&nbsp;e)<br>
<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Handlingopenviewsandbuffers">Handling open views and buffers</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;views&nbsp;=&nbsp;ref&nbsp;([]&nbsp;:&nbsp;sourceview&nbsp;list)<br>
<span class="keyword">let</span>&nbsp;buffers&nbsp;=&nbsp;ref&nbsp;([]&nbsp;:&nbsp;buffered_file&nbsp;list)<br>
<span class="keyword">let</span>&nbsp;active_sourceview&nbsp;=&nbsp;ref&nbsp;(<span class="constructor">None</span>&nbsp;:&nbsp;sourceview&nbsp;option)<br>
<br>
<span class="keyword">let</span>&nbsp;set_active_sourceview&nbsp;o&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">List</span>.exists&nbsp;(<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Oo</span>.id&nbsp;v&nbsp;=&nbsp;<span class="constructor">Oo</span>.id&nbsp;o)&nbsp;!views&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;active_sourceview&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;o;<br>
&nbsp;&nbsp;make_buffer_first_in_history&nbsp;o<span class="keywordsign">#</span>buffer_name<br>
<br>
<span class="keyword">let</span>&nbsp;get_fresh_buffer_name&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name_of_n&nbsp;n&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;n&nbsp;&lt;=&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s&lt;%d&gt;"</span>&nbsp;name&nbsp;n<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;iter&nbsp;n&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;name_of_n&nbsp;n&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">List</span>.exists&nbsp;(<span class="keyword">fun</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;b<span class="keywordsign">#</span>name&nbsp;=&nbsp;name)&nbsp;!buffers&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter&nbsp;(n+1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;iter&nbsp;1<br>
<br>
<span class="keyword">let</span>&nbsp;create_buffer&nbsp;?(attributes=[])&nbsp;filename&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mes&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"creating&nbsp;buffer&nbsp;for&nbsp;%s"</span>&nbsp;filename&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.display_message&nbsp;mes;<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="keyword">new</span>&nbsp;my_buffer&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;b<span class="keywordsign">#</span>set_max_undo_levels&nbsp;<span class="constructor">Ed_sourceview_rc</span>.max_undo_levels<span class="keywordsign">#</span>get;<br>
&nbsp;&nbsp;b<span class="keywordsign">#</span>place_cursor&nbsp;b<span class="keywordsign">#</span>start_iter;<br>
&nbsp;&nbsp;b<span class="keywordsign">#</span>set_highlight_syntax&nbsp;<span class="keyword">true</span>;<br>
&nbsp;&nbsp;b<span class="keywordsign">#</span>set_highlight_matching_brackets&nbsp;<span class="keyword">true</span>;<br>
&nbsp;&nbsp;<span class="constructor">Gtksv_utils</span>.register_source_buffer&nbsp;(b&nbsp;:&gt;&nbsp;<span class="constructor">GSourceView2</span>.source_buffer);<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;get_fresh_buffer_name&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;filename)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;file&nbsp;=&nbsp;<span class="keyword">new</span>&nbsp;buffered_file&nbsp;~attributes&nbsp;~name&nbsp;~filename&nbsp;b&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;buffers&nbsp;:=&nbsp;file&nbsp;::&nbsp;!buffers;<br>
&nbsp;&nbsp;make_buffer_first_in_history&nbsp;file<span class="keywordsign">#</span>name;<br>
&nbsp;&nbsp;file<br>
<br>
<span class="keyword">let</span>&nbsp;get_buffer&nbsp;?(attributes=[])&nbsp;filename&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;(Sys.file_exists&nbsp;filename)&nbsp;then&nbsp;raise&nbsp;Not_found;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;<span class="constructor">List</span>.find<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.safe_same_files&nbsp;f<span class="keywordsign">#</span>filename&nbsp;filename)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!buffers<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;loc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;get_att&nbsp;<span class="string">"location"</span>&nbsp;attributes&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;location_of_string&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;loc&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;loc&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;b<span class="keywordsign">#</span>select_location&nbsp;loc<br>
&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;b<br>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;create_buffer&nbsp;~attributes&nbsp;filename<br>
<br>
<span class="keyword">let</span>&nbsp;get_buffer_by_name&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">List</span>.find&nbsp;(<span class="keyword">fun</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;b<span class="keywordsign">#</span>name&nbsp;=&nbsp;name)&nbsp;!buffers<br>
<br>
<span class="keyword">let</span>&nbsp;remove_buffer&nbsp;(b&nbsp;:&nbsp;buffered_file)&nbsp;=<br>
&nbsp;&nbsp;buffers&nbsp;:=&nbsp;<span class="constructor">List</span>.filter&nbsp;(<span class="keyword">fun</span>&nbsp;b2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;b<span class="keywordsign">#</span>filename&nbsp;&lt;&gt;&nbsp;b2<span class="keywordsign">#</span>filename)&nbsp;!buffers;<br>
&nbsp;&nbsp;remove_buffer_from_history&nbsp;b<span class="keywordsign">#</span>name;<br>
&nbsp;&nbsp;<span class="constructor">Gtksv_utils</span>.unregister_source_buffer&nbsp;(b<span class="keywordsign">#</span>buffer&nbsp;:&gt;&nbsp;<span class="constructor">GSourceView2</span>.source_buffer)<br>
;;<br>
<br>
<span class="keyword">let</span>&nbsp;on_view_destroy&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;views&nbsp;:=&nbsp;<span class="constructor">List</span>.filter&nbsp;(<span class="keyword">fun</span>&nbsp;v2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Oo</span>.id&nbsp;v&nbsp;&lt;&gt;&nbsp;<span class="constructor">Oo</span>.id&nbsp;v2)&nbsp;!views;<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!active_sourceview&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;v2&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">Oo</span>.id&nbsp;v&nbsp;=&nbsp;<span class="constructor">Oo</span>.id&nbsp;v2&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active_sourceview&nbsp;:=&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;_<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;create_view&nbsp;?(attributes=[])&nbsp;topwin&nbsp;file&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=&nbsp;<span class="keyword">new</span>&nbsp;sourceview&nbsp;~attributes&nbsp;topwin&nbsp;on_view_destroy<br>
&nbsp;&nbsp;&nbsp;&nbsp;set_active_sourceview&nbsp;dup&nbsp;file_rename&nbsp;file<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;ignore(v<span class="keywordsign">#</span>source_view<span class="keywordsign">#</span>connect<span class="keywordsign">#</span>destroy&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;on_view_destroy&nbsp;v));<br>
&nbsp;&nbsp;views&nbsp;:=&nbsp;v&nbsp;::&nbsp;!views;<br>
&nbsp;&nbsp;v<br>
<br>
<span class="keyword">and</span>&nbsp;dup&nbsp;file&nbsp;topwin&nbsp;=<br>
&nbsp;&nbsp;(create_view&nbsp;topwin&nbsp;file&nbsp;:&gt;&nbsp;<span class="constructor">Ed_view</span>.gui_view)<br>
<br>
<span class="keyword">and</span>&nbsp;file_rename&nbsp;oldname&nbsp;newname&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;ignore(<span class="constructor">List</span>.find&nbsp;(<span class="keyword">fun</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_misc</span>.safe_same_files&nbsp;b<span class="keywordsign">#</span>filename&nbsp;newname)&nbsp;!buffers);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mes&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s&nbsp;is&nbsp;already&nbsp;open.&nbsp;Close&nbsp;it&nbsp;before."</span>&nbsp;newname&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;mes<br>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;search&nbsp;on&nbsp;names&nbsp;here,&nbsp;not&nbsp;dev/inode&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;views&nbsp;=&nbsp;<span class="constructor">List</span>.filter&nbsp;(<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<span class="keywordsign">#</span>filename&nbsp;=&nbsp;oldname)&nbsp;!views&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;get_buffer&nbsp;oldname&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;old_buffer_name&nbsp;=&nbsp;b<span class="keywordsign">#</span>name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>set_filename&nbsp;newname;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>set_name&nbsp;(get_fresh_buffer_name&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;newname));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rename_buffer_in_history&nbsp;old_buffer_name&nbsp;b<span class="keywordsign">#</span>name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;(<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<span class="keywordsign">#</span>my_set_label;&nbsp;v<span class="keywordsign">#</span>display_state)&nbsp;views<br>
<br>
<span class="keyword">let</span>&nbsp;open_file&nbsp;topwin&nbsp;active_view&nbsp;?(attributes=[])&nbsp;filename&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;file&nbsp;=&nbsp;get_buffer&nbsp;~attributes&nbsp;filename&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!active_sourceview&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">New_view</span>&nbsp;(create_view&nbsp;~attributes&nbsp;topwin&nbsp;file&nbsp;:&gt;&nbsp;<span class="constructor">Ed_view</span>.gui_view)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;topwin<span class="keywordsign">#</span>contains_view&nbsp;(v&nbsp;:&gt;&nbsp;<span class="constructor">Ed_view</span>.gui_view)&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>name&nbsp;=&nbsp;file<span class="keywordsign">#</span>name&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;get_att&nbsp;<span class="string">"location"</span>&nbsp;attributes&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<span class="keywordsign">#</span>select_location_opt&nbsp;(location_of_string&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>set_file&nbsp;~focus_in:&nbsp;<span class="keyword">true</span>&nbsp;file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Use_view</span>&nbsp;(v&nbsp;:&gt;&nbsp;<span class="constructor">Ed_view</span>.gui_view)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">New_view</span>&nbsp;(create_view&nbsp;~attributes&nbsp;topwin&nbsp;file&nbsp;:&gt;&nbsp;<span class="constructor">Ed_view</span>.gui_view)<br>
;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Factory">Factory</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">class</span>&nbsp;factory&nbsp;:&nbsp;<span class="constructor">Ed_view</span>.view_factory&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;name&nbsp;=&nbsp;factory_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;open_file&nbsp;=&nbsp;open_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;open_hidden&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keyword">fun</span>&nbsp;?attributes&nbsp;filename&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;ignore&nbsp;(get_buffer&nbsp;?attributes&nbsp;filename))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;on_start&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;buffers&nbsp;=&nbsp;read_open_buffers_file&nbsp;!open_buffers_file&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(f,&nbsp;attributes)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Sys</span>.file_exists&nbsp;f&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(get_buffer&nbsp;~attributes&nbsp;f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffers<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.catch_print_exceptions&nbsp;f&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;on_exit&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.catch_print_exceptions<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(write_open_buffers_file&nbsp;!open_buffers_file)&nbsp;!buffers;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.catch_print_exceptions<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Ed_bookmarks</span>.store&nbsp;bookmarks)&nbsp;<span class="constructor">Ed_sourceview_rc</span>.bookmarks_rc_file<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;_&nbsp;=&nbsp;<span class="constructor">Ed_view</span>.register_view_factory&nbsp;factory_name&nbsp;(<span class="keyword">new</span>&nbsp;factory)<br>
;;<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Forwardstackoflocations">"Forward-stack" of locations.</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;location_stack&nbsp;=&nbsp;<span class="constructor">Ed_fstack</span>.create&nbsp;();;<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h2 id="2_Commands">Commands</h2> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;keep_key_bindings_from_view&nbsp;v&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;iter&nbsp;acc&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;acc<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(k,com)&nbsp;::&nbsp;q&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">List</span>.mem&nbsp;com&nbsp;l&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter&nbsp;((k,&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;com)&nbsp;::&nbsp;acc)&nbsp;q<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter&nbsp;acc&nbsp;q<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;iter&nbsp;[]&nbsp;v<span class="keywordsign">#</span>key_bindings<br>
<br>
<span class="keyword">let</span>&nbsp;register_com&nbsp;~prefix&nbsp;name&nbsp;args&nbsp;?more&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_%s"</span>&nbsp;prefix&nbsp;name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!active_sourceview&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;v&nbsp;args<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;c&nbsp;=&nbsp;{&nbsp;<span class="constructor">Ed_commands</span>.com_name&nbsp;=&nbsp;name&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;com_args&nbsp;=&nbsp;args&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;com_more_args&nbsp;=&nbsp;more&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;com_f&nbsp;=&nbsp;f&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.register&nbsp;c<br>
<br>
<span class="keyword">let</span>&nbsp;switch_to_buffer&nbsp;(v&nbsp;:&nbsp;sourceview)&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;get_buffer_by_name&nbsp;name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>set_file&nbsp;~focus_in:&nbsp;<span class="keyword">true</span>&nbsp;b<br>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.error_message<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"No&nbsp;%s&nbsp;buffer&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory_name&nbsp;(utf8_of_filename&nbsp;name))<br>
<br>
<span class="keyword">let</span>&nbsp;candidate_buffers&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;displayed_buffers&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;(<span class="keyword">fun</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;o<span class="keywordsign">#</span>buffer_name)&nbsp;!views&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(last,first)&nbsp;=&nbsp;<span class="constructor">List</span>.partition<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;name&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">List</span>.mem&nbsp;name&nbsp;displayed_buffers)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!buffer_name_history<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;first&nbsp;@&nbsp;last<br>
<br>
<span class="keyword">let</span>&nbsp;switch_buffer_history&nbsp;=&nbsp;<span class="constructor">Ed_minibuffer</span>.history&nbsp;()<br>
<span class="keyword">let</span>&nbsp;switch_buffer&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;args.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;switch_to_buffer&nbsp;v&nbsp;name<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;propose&nbsp;list&nbsp;of&nbsp;available&nbsp;buffers&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;candidate_buffers&nbsp;=&nbsp;candidate_buffers&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_switch_buffer"</span>&nbsp;factory_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;candidate_buffers&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;s&nbsp;::&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.launch_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~history:<span class="keyword">false</span>&nbsp;com&nbsp;[|&nbsp;s&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.launch_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~history:<span class="keyword">false</span>&nbsp;com&nbsp;[|&nbsp;s&nbsp;|]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Switch&nbsp;to&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;candidate_buffers&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">|</span>&nbsp;s&nbsp;::&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"["</span>^(<span class="constructor">Glib</span>.<span class="constructor">Convert</span>.filename_to_utf8&nbsp;s)^<span class="string">"]"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.select_string<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~history:&nbsp;switch_buffer_history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>minibuffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~title<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~choices:&nbsp;(<span class="constructor">List</span>.map&nbsp;<span class="constructor">Glib</span>.<span class="constructor">Convert</span>.filename_to_utf8&nbsp;candidate_buffers)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f<br>
<br>
<span class="keyword">let</span>&nbsp;destroy_buffer&nbsp;(v&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bname&nbsp;=&nbsp;v<span class="keywordsign">#</span>buffer_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;remove_buffer&nbsp;v<span class="keywordsign">#</span>file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">List</span>.filter&nbsp;(<span class="keyword">fun</span>&nbsp;name&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;name&nbsp;&lt;&gt;&nbsp;bname)&nbsp;(candidate_buffers())&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;no&nbsp;more&nbsp;buffer&nbsp;to&nbsp;replace&nbsp;the&nbsp;destroyed&nbsp;one,&nbsp;destroy&nbsp;all&nbsp;views&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;(<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<span class="keywordsign">#</span>destroy)&nbsp;!views<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;first&nbsp;::&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;buf&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;get_buffer_by_name&nbsp;first<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"Internal&nbsp;error;&nbsp;Please&nbsp;restart&nbsp;to&nbsp;be&nbsp;safe."</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(v:sourceview)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;v<span class="keywordsign">#</span>buffer_name&nbsp;=&nbsp;bname&nbsp;<span class="keyword">then</span>&nbsp;v<span class="keywordsign">#</span>set_file&nbsp;~focus_in:&nbsp;<span class="keyword">true</span>&nbsp;buf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!views<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;v<span class="keywordsign">#</span>buffer_modified&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.confirm&nbsp;v<span class="keywordsign">#</span>minibuffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Buffer&nbsp;%s&nbsp;modified;&nbsp;destroy&nbsp;anyway&nbsp;?"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(utf8_of_filename&nbsp;v<span class="keywordsign">#</span>buffer_name))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f<br>
<br>
<br>
<span class="keyword">type</span>&nbsp;search_buffer_function&nbsp;=<br>
&nbsp;&nbsp;?wrapped:bool&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my_buffer&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?start:<span class="constructor">GText</span>.iter&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bool&nbsp;*&nbsp;(<span class="constructor">GText</span>.iter&nbsp;*&nbsp;<span class="constructor">GText</span>.iter)&nbsp;option<br>
<br>
<span class="keyword">let</span>&nbsp;prev_search&nbsp;=&nbsp;ref&nbsp;<span class="constructor">None</span><br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;search_buffer&nbsp;?(wrapped=<span class="keyword">false</span>)&nbsp;forward&nbsp;(buffer&nbsp;:&nbsp;my_buffer)<br>
&nbsp;&nbsp;?(start=buffer<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>)&nbsp;s_utf8&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gsearch&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;forward&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">GSourceView2</span>.iter_forward_search<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">GSourceView2</span>.iter_backward_search<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stop&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>end_iter&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;gsearch&nbsp;start&nbsp;[]&nbsp;~start&nbsp;~stop&nbsp;s_utf8&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;wrapped&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(wrapped,&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;start&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;forward&nbsp;<span class="keyword">then</span>&nbsp;buffer<span class="keywordsign">#</span>start_iter&nbsp;<span class="keyword">else</span>&nbsp;buffer<span class="keywordsign">#</span>end_iter&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;search_buffer&nbsp;~wrapped:&nbsp;<span class="keyword">true</span>&nbsp;forward&nbsp;buffer&nbsp;~start&nbsp;s_utf8<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(start,stop)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(wrapped,&nbsp;<span class="constructor">Some</span>&nbsp;(start,&nbsp;stop))<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;search&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;forward&nbsp;=&nbsp;ref&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;(fsearch_buffer&nbsp;:&nbsp;search_buffer_function)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mes&nbsp;?(changed=<span class="keyword">false</span>)&nbsp;_forward&nbsp;(v:&nbsp;sourceview)&nbsp;args&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forward&nbsp;:=&nbsp;_forward;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fixed&nbsp;wrapped&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s%s%s:&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;wrapped&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"[wrapped]&nbsp;"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;!forward&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">"&nbsp;backward"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mb&nbsp;=&nbsp;v<span class="keywordsign">#</span>minibuffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;mb<span class="keywordsign">#</span>active&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s_utf8&nbsp;=&nbsp;mb<span class="keywordsign">#</span>get_user_text&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;s_utf8&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;!prev_search&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mb<span class="keywordsign">#</span>set_user_text&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;("search&nbsp;"^(Ed_misc.of_utf8&nbsp;s_utf8));*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;start&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;changed&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(start,&nbsp;stop)&nbsp;=&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>selection_bounds&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keyword">if</span>&nbsp;!forward&nbsp;<span class="keyword">then</span>&nbsp;start&nbsp;<span class="keyword">else</span>&nbsp;stop)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fsearch_buffer&nbsp;!forward&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer&nbsp;?start&nbsp;s_utf8&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(wrapped,&nbsp;<span class="constructor">None</span>)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_text&nbsp;~fixed:&nbsp;(fixed&nbsp;wrapped)&nbsp;s_utf8<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(wrapped,&nbsp;<span class="constructor">Some</span>&nbsp;(start,&nbsp;stop))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"found&nbsp;start=%d,%d"&nbsp;start#line&nbsp;start#line_offset);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"and&nbsp;stop=%d,%d"&nbsp;stop#line&nbsp;stop#line_offset);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;loc&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;!forward&nbsp;<span class="keyword">then</span>&nbsp;stop&nbsp;<span class="keyword">else</span>&nbsp;start&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location_of_iter&nbsp;it<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>set_location&nbsp;loc;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!forward&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>select_range&nbsp;stop&nbsp;start<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>select_range&nbsp;start&nbsp;stop;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(v<span class="keywordsign">#</span>source_view<span class="keywordsign">#</span>scroll_to_iter&nbsp;start);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(v<span class="keywordsign">#</span>source_view<span class="keywordsign">#</span>scroll_to_iter&nbsp;stop);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_text&nbsp;~fixed:&nbsp;(fixed&nbsp;wrapped)&nbsp;s_utf8<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;on_changed&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;do&nbsp;not&nbsp;do&nbsp;anything&nbsp;if&nbsp;there&nbsp;is&nbsp;nothing&nbsp;to&nbsp;search<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;the&nbsp;searched&nbsp;string&nbsp;has&nbsp;not&nbsp;changed,&nbsp;to&nbsp;prevent<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;moving&nbsp;to&nbsp;next&nbsp;search&nbsp;when&nbsp;changing&nbsp;the&nbsp;fixed&nbsp;text<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;the&nbsp;minibuffer&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;mb<span class="keywordsign">#</span>get_user_text&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!prev_search&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prev_search&nbsp;:=&nbsp;<span class="constructor">Some</span>&nbsp;s;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;search&nbsp;fsearch_buffer&nbsp;mes&nbsp;~changed:&nbsp;<span class="keyword">true</span>&nbsp;!forward&nbsp;&nbsp;v&nbsp;args<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>clear;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_text&nbsp;~fixed:&nbsp;(fixed&nbsp;<span class="keyword">false</span>)&nbsp;<span class="string">""</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_on_text_changed&nbsp;on_changed;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_more_key_bindings<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(keep_key_bindings_from_view&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;factory_name^<span class="string">"_search"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory_name^<span class="string">"_search_backward"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory_name^<span class="string">"_search_re"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory_name^<span class="string">"_search_re_backward"</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_active&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;re_search_buffer&nbsp;?(wrapped=<span class="keyword">false</span>)&nbsp;forward&nbsp;(buffer:&nbsp;my_buffer)&nbsp;?start&nbsp;s_utf8&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(start,&nbsp;stop)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;forward&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;start&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(buffer<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>,&nbsp;buffer<span class="keywordsign">#</span>end_iter)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(i,&nbsp;buffer<span class="keywordsign">#</span>end_iter)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;start&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(buffer<span class="keywordsign">#</span>start_iter,&nbsp;buffer<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(buffer<span class="keywordsign">#</span>start_iter,&nbsp;i)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gsearch&nbsp;=&nbsp;buffer<span class="keywordsign">#</span>re_search&nbsp;forward&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;gsearch&nbsp;~start&nbsp;~stop&nbsp;(<span class="constructor">Pcre</span>.regexp&nbsp;s_utf8)&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;wrapped&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(wrapped,&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;start&nbsp;=&nbsp;<span class="keyword">if</span>&nbsp;forward&nbsp;<span class="keyword">then</span>&nbsp;buffer<span class="keywordsign">#</span>start_iter&nbsp;<span class="keyword">else</span>&nbsp;buffer<span class="keywordsign">#</span>end_iter&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;re_search_buffer&nbsp;~wrapped:&nbsp;<span class="keyword">true</span>&nbsp;forward&nbsp;buffer&nbsp;~start&nbsp;s_utf8<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(start,stop)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(wrapped,&nbsp;<span class="constructor">Some</span>&nbsp;(start,&nbsp;stop))<br>
<br>
<span class="keyword">let</span>&nbsp;replace_history&nbsp;=&nbsp;<span class="constructor">Ed_minibuffer</span>.history&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;query_replace_gen<br>
&nbsp;&nbsp;?(mes=<span class="string">""</span>)<br>
&nbsp;&nbsp;command_name<br>
&nbsp;&nbsp;(fsearch_buffer&nbsp;:&nbsp;search_buffer_function)<br>
&nbsp;&nbsp;(freplace&nbsp;:&nbsp;searched:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;found:string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;repl:string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string)<br>
&nbsp;&nbsp;(v&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mb&nbsp;=&nbsp;v<span class="keywordsign">#</span>minibuffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;len&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;len&nbsp;&lt;=&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;s&nbsp;=&nbsp;<span class="constructor">Ed_commands</span>.launch_command&nbsp;command_name&nbsp;[|&nbsp;s&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Query-replace%s"</span>&nbsp;mes&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.input_string&nbsp;~history:&nbsp;replace_history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb&nbsp;~title&nbsp;<span class="string">""</span>&nbsp;f<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;len&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=&nbsp;<span class="constructor">Ed_misc</span>.to_utf8<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Query-replace%s&nbsp;%s&nbsp;with"</span>&nbsp;mes&nbsp;args.(0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;s&nbsp;=&nbsp;<span class="constructor">Ed_commands</span>.launch_command&nbsp;command_name&nbsp;[|&nbsp;args.(0);&nbsp;s&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.input_string&nbsp;~history:&nbsp;replace_history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb&nbsp;~title&nbsp;<span class="string">""</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=&nbsp;<span class="constructor">Ed_misc</span>.to_utf8<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Query-replace%s&nbsp;%s&nbsp;with&nbsp;%s&nbsp;(y/n/!)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mes&nbsp;args.(0)&nbsp;args.(1))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s1_utf8&nbsp;=&nbsp;<span class="constructor">Ed_misc</span>.to_utf8&nbsp;args.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s2_utf8&nbsp;=&nbsp;<span class="constructor">Ed_misc</span>.to_utf8&nbsp;args.(1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;iter&nbsp;interactive&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b&nbsp;=&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;it&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_iter&nbsp;<span class="keywordsign">`</span><span class="constructor">INSERT</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;start&nbsp;=&nbsp;it&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fsearch_buffer&nbsp;<span class="keyword">true</span>&nbsp;<span class="comment">(*=forward*)</span>&nbsp;b&nbsp;~start&nbsp;s1_utf8&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">true</span>,&nbsp;_<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_,&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mb<span class="keywordsign">#</span>set_active&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>,&nbsp;<span class="constructor">Some</span>&nbsp;(start,stop)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;interactive&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>set_location&nbsp;(location_of_iter&nbsp;start);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>select_range&nbsp;start&nbsp;stop;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(v<span class="keywordsign">#</span>source_view<span class="keywordsign">#</span>scroll_to_iter&nbsp;start);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore(v<span class="keywordsign">#</span>source_view<span class="keywordsign">#</span>scroll_to_iter&nbsp;stop)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;replace&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>place_cursor&nbsp;~scroll:&nbsp;interactive&nbsp;start;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;found&nbsp;=&nbsp;b<span class="keywordsign">#</span>get_text&nbsp;~start&nbsp;~stop&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>delete&nbsp;~start&nbsp;~stop;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Printf.sprintf&nbsp;"searched=%s,&nbsp;found=%s,&nbsp;repl=%s"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s1_utf8&nbsp;found&nbsp;s2_utf8);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;new_text&nbsp;=&nbsp;freplace<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~searched:&nbsp;s1_utf8&nbsp;~found&nbsp;~repl:&nbsp;s2_utf8<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>insert&nbsp;new_text<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;interactive&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_yes&nbsp;()&nbsp;=&nbsp;replace&nbsp;();&nbsp;iter&nbsp;<span class="keyword">true</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_no&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>place_cursor&nbsp;stop;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f_bang&nbsp;()&nbsp;=&nbsp;replace&nbsp;();&nbsp;iter&nbsp;<span class="keyword">false</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>clear;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_more_key_bindings<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;[[],&nbsp;<span class="constructor">GdkKeysyms</span>._y],&nbsp;f_yes&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[[],&nbsp;<span class="constructor">GdkKeysyms</span>._n],&nbsp;f_no&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[[],&nbsp;<span class="constructor">GdkKeysyms</span>._exclam],&nbsp;f_bang&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_text&nbsp;~fixed:&nbsp;title&nbsp;<span class="string">""</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;mb<span class="keywordsign">#</span>active&nbsp;<span class="keyword">then</span>&nbsp;(mb<span class="keywordsign">#</span>set_active&nbsp;<span class="keyword">true</span>;&nbsp;mb<span class="keywordsign">#</span>wait);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(replace&nbsp;();&nbsp;iter&nbsp;interactive)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iter&nbsp;<span class="keyword">true</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;query_replace&nbsp;=&nbsp;query_replace_gen<br>
&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_query_replace"</span>&nbsp;factory_name)<br>
&nbsp;&nbsp;search_buffer<br>
&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;~searched&nbsp;~found&nbsp;~repl&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;repl)<br>
<br>
<span class="keyword">let</span>&nbsp;re_replace&nbsp;~searched&nbsp;~found&nbsp;~repl&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;rex&nbsp;=&nbsp;<span class="constructor">Pcre</span>.regexp&nbsp;searched&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Pcre</span>.replace_first&nbsp;~rex&nbsp;~templ:&nbsp;repl&nbsp;found<br>
<br>
<span class="keyword">let</span>&nbsp;re_query_replace&nbsp;=&nbsp;query_replace_gen<br>
&nbsp;&nbsp;~mes:&nbsp;<span class="string">"&nbsp;regexp"</span><br>
&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_query_replace_re"</span>&nbsp;factory_name)<br>
&nbsp;&nbsp;re_search_buffer<br>
&nbsp;&nbsp;re_replace<br>
<br>
<span class="keyword">let</span>&nbsp;paste&nbsp;(v:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;text&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;len&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;len&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;args.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;selection&nbsp;=&nbsp;<span class="constructor">GMain</span>.selection<span class="keywordsign">#</span>text&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"Selection=%s"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(match&nbsp;selection&nbsp;with&nbsp;None&nbsp;-&gt;&nbsp;"&lt;None&gt;"&nbsp;|&nbsp;Some&nbsp;s&nbsp;-&gt;&nbsp;s));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;selection&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">GMain</span>.clipboard<span class="keywordsign">#</span>text<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prerr_endline&nbsp;(Printf.sprintf&nbsp;"Text=%s"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(match&nbsp;text&nbsp;with&nbsp;None&nbsp;-&gt;&nbsp;"&lt;None&gt;"&nbsp;|&nbsp;Some&nbsp;s&nbsp;-&gt;&nbsp;s));<br>
&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;text&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;text&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pastable_history<span class="keywordsign">#</span>add&nbsp;(<span class="constructor">Ed_misc</span>.to_utf8&nbsp;text);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>insert&nbsp;text;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>update_my_location<br>
<br>
<span class="keyword">let</span>&nbsp;copy&nbsp;(v:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>copy_clipboard&nbsp;<span class="constructor">GMain</span>.clipboard<br>
<span class="keyword">let</span>&nbsp;cut&nbsp;(v:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;v<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>cut_clipboard&nbsp;<span class="constructor">GMain</span>.clipboard;<br>
&nbsp;&nbsp;v<span class="keywordsign">#</span>update_my_location<br>
<br>
<span class="keyword">let</span>&nbsp;beginning_of_line&nbsp;(v&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>beginning_of_line<br>
<span class="keyword">let</span>&nbsp;end_of_line&nbsp;(v&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>end_of_line<br>
<span class="keyword">let</span>&nbsp;undo&nbsp;(v&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>undo<br>
<span class="keyword">let</span>&nbsp;redo&nbsp;(v&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>redo<br>
<span class="keyword">let</span>&nbsp;forward_word&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>forward_word<br>
<span class="keyword">let</span>&nbsp;backward_word&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>backward_word<br>
<span class="keyword">let</span>&nbsp;forward_line&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>forward_line<br>
<span class="keyword">let</span>&nbsp;backward_line&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>backward_line<br>
<span class="keyword">let</span>&nbsp;forward_char&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>forward_char<br>
<span class="keyword">let</span>&nbsp;backward_char&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>backward_char<br>
<span class="keyword">let</span>&nbsp;kill_line&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;v<span class="keywordsign">#</span>kill_line&nbsp;~append:&nbsp;(<span class="constructor">Ed_commands</span>.same_previous_command&nbsp;())<br>
<br>
<span class="keyword">let</span>&nbsp;kill_word&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Ed_commands</span>.same_previous_command&nbsp;()&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">APPEND</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;v<span class="keywordsign">#</span>kill_word&nbsp;?concat&nbsp;<span class="keyword">true</span><br>
<br>
<span class="keyword">let</span>&nbsp;backward_kill_word&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Ed_commands</span>.same_previous_command&nbsp;()&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">PREPEND</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;v<span class="keywordsign">#</span>kill_word&nbsp;?concat&nbsp;<span class="keyword">false</span><br>
<br>
<span class="keyword">let</span>&nbsp;delete_char&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>delete_char&nbsp;<span class="keyword">true</span><br>
<span class="keyword">let</span>&nbsp;backward_delete_char&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>delete_char&nbsp;<span class="keyword">false</span><br>
<br>
<span class="keyword">let</span>&nbsp;transpose_chars&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>transpose_chars<br>
<span class="keyword">let</span>&nbsp;transpose_lines&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>transpose_lines<br>
<span class="keyword">let</span>&nbsp;transpose_words&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>transpose_words<br>
<br>
<span class="keyword">let</span>&nbsp;yank_choose&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mb&nbsp;=&nbsp;v<span class="keywordsign">#</span>minibuffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;title&nbsp;=&nbsp;<span class="string">"Choose&nbsp;text&nbsp;to&nbsp;paste&nbsp;(Up/Down&nbsp;to&nbsp;choose):"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;on_eval&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s_utf8&nbsp;=&nbsp;mb<span class="keywordsign">#</span>get_user_text&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;paste&nbsp;v&nbsp;[|&nbsp;s_utf8&nbsp;|];<br>
&nbsp;&nbsp;&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_active&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;mb<span class="keywordsign">#</span>clear&nbsp;;<br>
&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_on_eval&nbsp;on_eval;<br>
&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_text&nbsp;~fixed:&nbsp;title&nbsp;<span class="string">""</span>;<br>
&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_history&nbsp;pastable_history;<br>
&nbsp;&nbsp;mb<span class="keywordsign">#</span>set_active&nbsp;<span class="keyword">true</span><br>
<br>
<span class="keyword">let</span>&nbsp;insert&nbsp;(v:sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Array</span>.iter&nbsp;v<span class="keywordsign">#</span>insert&nbsp;args<br>
<br>
<span class="keyword">let</span>&nbsp;goto_history&nbsp;=&nbsp;<span class="constructor">Ed_minibuffer</span>.history&nbsp;()<br>
<span class="keyword">let</span>&nbsp;goto_line&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;n&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Ed_misc</span>.my_int_of_string&nbsp;args.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;invalid_arg&nbsp;<span class="string">"Bad&nbsp;line&nbsp;number"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>goto_line&nbsp;(n-1)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.input_command_arg<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>minibuffer&nbsp;~history:&nbsp;goto_history<br>
&nbsp;&nbsp;&nbsp;&nbsp;~title:&nbsp;<span class="string">"Go&nbsp;to&nbsp;line"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_goto_line"</span>&nbsp;factory_name)&nbsp;args<br>
<br>
<span class="keyword">let</span>&nbsp;goto_char&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;n&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Ed_misc</span>.my_int_of_string&nbsp;args.(0)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;invalid_arg&nbsp;<span class="string">"Bad&nbsp;character&nbsp;number"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>goto_char&nbsp;(n-1)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.input_command_arg<br>
&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>minibuffer&nbsp;~history:&nbsp;goto_history<br>
&nbsp;&nbsp;&nbsp;&nbsp;~title:&nbsp;<span class="string">"Go&nbsp;to&nbsp;char"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_goto_char"</span>&nbsp;factory_name)&nbsp;args<br>
<br>
<span class="keyword">let</span>&nbsp;force_save&nbsp;v&nbsp;args&nbsp;=&nbsp;v<span class="keywordsign">#</span>do_save<br>
<br>
<span class="keyword">let</span>&nbsp;syntax_mode_history&nbsp;=&nbsp;<span class="constructor">Ed_minibuffer</span>.history&nbsp;()<br>
<span class="keyword">let</span>&nbsp;set_syntax_mode&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;len&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;len&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;args.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;langs&nbsp;=&nbsp;<span class="constructor">Gtksv_utils</span>.available_source_languages&nbsp;~manager:&nbsp;language_manager&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lang&nbsp;=&nbsp;<span class="constructor">List</span>.find&nbsp;(<span class="keyword">fun</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;l<span class="keywordsign">#</span>name&nbsp;=&nbsp;name)&nbsp;&nbsp;langs&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>set_syntax_mode&nbsp;(<span class="constructor">Some</span>&nbsp;lang)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Not_found</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.error_message<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"Unknown&nbsp;syntax&nbsp;mode&nbsp;\"%s\""</span>&nbsp;name)<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;mode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_set_syntax_mode&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory_name&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;mode)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;com<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;languages&nbsp;=&nbsp;<span class="constructor">List</span>.map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;l<span class="keywordsign">#</span>name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Gtksv_utils</span>.available_source_languages&nbsp;~manager:&nbsp;language_manager&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.select_string&nbsp;~history:&nbsp;syntax_mode_history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>minibuffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~title:&nbsp;<span class="string">"Syntax&nbsp;mode"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~choices:&nbsp;languages<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f<br>
<br>
<span class="keyword">let</span>&nbsp;popup_syntax_mode_choice&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_set_syntax_mode&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory_name&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;s))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;entries&nbsp;=&nbsp;<span class="constructor">List</span>.map<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(l<span class="keywordsign">#</span>name,&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;com&nbsp;l<span class="keywordsign">#</span>name))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Gtksv_utils</span>.sort_languages_by_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Gtksv_utils</span>.available_source_languages&nbsp;~manager:&nbsp;language_manager&nbsp;()))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">GToolbox</span>.popup_menu<br>
&nbsp;&nbsp;&nbsp;&nbsp;~button:&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;~time:&nbsp;(<span class="constructor">Int32</span>.zero)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~entries<br>
<br>
<span class="keyword">let</span>&nbsp;mode_history&nbsp;=&nbsp;<span class="constructor">Ed_minibuffer</span>.history&nbsp;()<br>
<span class="keyword">let</span>&nbsp;set_mode&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;len&nbsp;=&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;len&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;args.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Ed_extern</span>.no_blanks&nbsp;name&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<span class="keywordsign">#</span>set_mode&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<span class="keywordsign">#</span>set_mode&nbsp;(<span class="constructor">Some</span>&nbsp;(get_mode&nbsp;name))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Failure</span>&nbsp;s<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.error_message&nbsp;s<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;mode&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_set_mode&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory_name&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;mode)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;com<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.select_string&nbsp;~history:&nbsp;mode_history<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v<span class="keywordsign">#</span>minibuffer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~title:&nbsp;<span class="string">"Mode"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~choices:&nbsp;(available_mode_names&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f<br>
<br>
<span class="keyword">let</span>&nbsp;popup_mode_choice&nbsp;v&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_set_mode&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory_name&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;s))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;entries&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(<span class="string">"None"</span>,&nbsp;<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;com&nbsp;<span class="string">"''"</span>))&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">I</span>&nbsp;(s,&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;com&nbsp;s)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(available_mode_names&nbsp;()))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">GToolbox</span>.popup_menu<br>
&nbsp;&nbsp;&nbsp;&nbsp;~button:&nbsp;1<br>
&nbsp;&nbsp;&nbsp;&nbsp;~time:&nbsp;(<span class="constructor">Int32</span>.zero)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~entries<br>
<br>
<span class="keyword">let</span>&nbsp;switch_line_numbers&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Ed_misc</span>.bool_of_string&nbsp;args.(0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;view<span class="keywordsign">#</span>switch_line_numbers&nbsp;?v&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;switch_line_markers&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;&gt;&nbsp;0&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Ed_misc</span>.bool_of_string&nbsp;args.(0))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;view<span class="keywordsign">#</span>switch_line_markers&nbsp;?v&nbsp;()<br>
<br>
<span class="keyword">let</span>&nbsp;set_wrap_mode&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_set_wrap_mode"</span>&nbsp;factory_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;&lt;&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;s&nbsp;=&nbsp;<span class="constructor">Ed_commands</span>.launch_command&nbsp;com&nbsp;[|&nbsp;s&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.select_string&nbsp;view<span class="keywordsign">#</span>minibuffer&nbsp;~title:&nbsp;com<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~choices:&nbsp;(<span class="constructor">List</span>.map&nbsp;<span class="constructor">Ed_sourceview_rc</span>.string_of_wrap_mode&nbsp;[<span class="keywordsign">`</span><span class="constructor">CHAR</span>;<span class="keywordsign">`</span><span class="constructor">NONE</span>;<span class="keywordsign">`</span><span class="constructor">WORD</span>])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>&nbsp;f<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mode&nbsp;=&nbsp;<span class="constructor">Ed_sourceview_rc</span>.wrap_mode_of_string&nbsp;args.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;view<span class="keywordsign">#</span>set_wrap_mode&nbsp;mode<br>
<br>
<span class="keyword">let</span>&nbsp;insert_utf8&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;&lt;&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;code&nbsp;=&nbsp;int_of_string&nbsp;args.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;s&nbsp;=&nbsp;<span class="constructor">Ed_utf8</span>.utf8_char_of_code&nbsp;code&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view<span class="keywordsign">#</span>file<span class="keywordsign">#</span>buffer<span class="keywordsign">#</span>insert&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Invalid_argument</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mes&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"insert_utf8:&nbsp;invalid&nbsp;argument&nbsp;(%s)"</span>&nbsp;args.(0)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.error_message&nbsp;mes<br>
;;<br>
<br>
<span class="keyword">let</span>&nbsp;set_encoding&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;&lt;&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_set_encoding"</span>&nbsp;factory_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;s&nbsp;=&nbsp;<span class="constructor">Ed_commands</span>.launch_command&nbsp;com&nbsp;[|&nbsp;s&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.select_string&nbsp;view<span class="keywordsign">#</span>minibuffer&nbsp;~title:&nbsp;com<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~choices:&nbsp;<span class="constructor">Ed_charsets</span>.charsets<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>&nbsp;f<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;view<span class="keywordsign">#</span>set_encoding&nbsp;(<span class="constructor">Some</span>&nbsp;args.(0))<br>
;;<br>
<br>
<span class="keyword">let</span>&nbsp;set_bookmark&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_set_bookmark"</span>&nbsp;factory_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;&lt;&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;s&nbsp;=&nbsp;<span class="constructor">Ed_commands</span>.launch_command&nbsp;com&nbsp;[|&nbsp;s&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.input_string&nbsp;view<span class="keywordsign">#</span>minibuffer&nbsp;~title:&nbsp;com<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;data&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(l,c)&nbsp;=&nbsp;view<span class="keywordsign">#</span>location_in_buffer&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(view<span class="keywordsign">#</span>filename,&nbsp;l,&nbsp;c)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_bookmarks</span>.set&nbsp;bookmarks&nbsp;args.(0)&nbsp;data;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view<span class="keywordsign">#</span>file<span class="keywordsign">#</span>update_source_marks;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view<span class="keywordsign">#</span>update_menus<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
;;<br>
<br>
<span class="keyword">let</span>&nbsp;remove_bookmark&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;com&nbsp;=&nbsp;<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"%s_remove_bookmark"</span>&nbsp;factory_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Array</span>.length&nbsp;args&nbsp;&lt;&nbsp;1&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;choices&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;fst&nbsp;(<span class="constructor">Ed_bookmarks</span>.list&nbsp;bookmarks)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;s&nbsp;=&nbsp;<span class="constructor">Ed_commands</span>.launch_command&nbsp;com&nbsp;[|&nbsp;s&nbsp;|]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.select_string&nbsp;view<span class="keywordsign">#</span>minibuffer&nbsp;~title:&nbsp;com<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~choices<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">""</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_bookmarks</span>.remove&nbsp;bookmarks&nbsp;args.(0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view<span class="keywordsign">#</span>update_menus<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
;;<br>
<br>
<span class="keyword">let</span>&nbsp;push_location&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;loc&nbsp;=&nbsp;(view<span class="keywordsign">#</span>filename,&nbsp;view<span class="keywordsign">#</span>location_in_buffer)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Ed_fstack</span>.push&nbsp;loc&nbsp;location_stack;<br>
&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.set_active_action_message&nbsp;<span class="string">"Location&nbsp;pushed"</span><br>
;;<br>
<br>
<span class="keyword">let</span>&nbsp;pop_location&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(file,&nbsp;(line,col))&nbsp;=&nbsp;<span class="constructor">Ed_fstack</span>.pop&nbsp;location_stack&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"open_file&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;file));<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;view<span class="keywordsign">#</span>filename&nbsp;=&nbsp;file&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view<span class="keywordsign">#</span>set_location&nbsp;(line,col)<br>
&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_fstack</span>.<span class="constructor">Empty</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;<span class="string">"Location&nbsp;stack&nbsp;is&nbsp;empty"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_hooks</span>.error_message&nbsp;m;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.set_active_action_message&nbsp;m<br>
<br>
;;<br>
<br>
<span class="keyword">let</span>&nbsp;forward_location&nbsp;(view&nbsp;:&nbsp;sourceview)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">try</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(file,&nbsp;(line,col))&nbsp;=&nbsp;<span class="constructor">Ed_fstack</span>.forward&nbsp;location_stack&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_commands</span>.eval_command&nbsp;(<span class="constructor">Printf</span>.sprintf&nbsp;<span class="string">"open_file&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;file));<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;view<span class="keywordsign">#</span>filename&nbsp;=&nbsp;file&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view<span class="keywordsign">#</span>set_location&nbsp;(line,col)<br>
&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_fstack</span>.<span class="constructor">Empty</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;m&nbsp;=&nbsp;<span class="string">"Location&nbsp;stack&nbsp;is&nbsp;forward-empty"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_hooks</span>.error_message&nbsp;m;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ed_misc</span>.set_active_action_message&nbsp;m<br>
;;<br>
<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;coms&nbsp;=<br>
&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"switch_buffer"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;switch_buffer&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"destroy_buffer"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;destroy_buffer&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"query_replace"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;query_replace&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"query_replace_re"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;re_query_replace&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"search"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;search&nbsp;search_buffer&nbsp;<span class="string">"search"</span>&nbsp;<span class="keyword">true</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"search_backward"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;search&nbsp;search_buffer&nbsp;<span class="string">"search"</span>&nbsp;<span class="keyword">false</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"search_re"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;search&nbsp;re_search_buffer&nbsp;<span class="string">"regexp&nbsp;search"</span>&nbsp;<span class="keyword">true</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"search_re_backward"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;search&nbsp;re_search_buffer&nbsp;<span class="string">"regexp&nbsp;search"</span>&nbsp;<span class="keyword">false</span>&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"beginning_of_line"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;beginning_of_line&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"end_of_line"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;end_of_line&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"undo"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;undo&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"redo"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;redo&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"forward_word"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;forward_word&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"backward_word"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;backward_word&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"forward_line"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;forward_line&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"backward_line"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;backward_line&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"forward_char"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;forward_char&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"backward_char"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;backward_char&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"paste"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;paste&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"copy"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;copy&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"cut"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;cut&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"kill_line"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;kill_line&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"kill_word"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;kill_word&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"backward_kill_word"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;backward_kill_word&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"yank_choose"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;yank_choose&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"insert"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"utf8&nbsp;strings&nbsp;to&nbsp;insert"</span>,&nbsp;insert&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"goto_line"</span>,&nbsp;[|<span class="string">"line"</span>|],&nbsp;<span class="constructor">None</span>,&nbsp;goto_line&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"goto_char"</span>,&nbsp;[|<span class="string">"character"</span>|],&nbsp;<span class="constructor">None</span>,&nbsp;goto_char&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"force_save"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;force_save&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"delete_char"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;delete_char&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"backward_delete_char"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;backward_delete_char&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"transpose_chars"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;transpose_chars&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"transpose_lines"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;transpose_lines&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"transpose_words"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;transpose_words&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"set_syntax_mode"</span>,&nbsp;[|&nbsp;<span class="string">"Syntax&nbsp;mode"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;set_syntax_mode&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"popup_syntax_mode_choice"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;popup_syntax_mode_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"set_mode"</span>,&nbsp;[|&nbsp;<span class="string">"Mode"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;set_mode&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"popup_mode_choice"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;popup_mode_choice&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"switch_line_numbers"</span>,&nbsp;[|&nbsp;<span class="string">"optional&nbsp;value"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;switch_line_numbers&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"switch_line_markers"</span>,&nbsp;[|&nbsp;<span class="string">"optional&nbsp;value"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;switch_line_markers&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"set_wrap_mode"</span>,&nbsp;[|&nbsp;<span class="string">"mode"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;set_wrap_mode&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"insert_utf8"</span>,&nbsp;[|&nbsp;<span class="string">"utf8&nbsp;code"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;insert_utf8&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"set_encoding"</span>,&nbsp;[|&nbsp;<span class="string">"encoding"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;set_encoding&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"set_bookmark"</span>,&nbsp;[|&nbsp;<span class="string">"name"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;set_bookmark&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"remove_bookmark"</span>,&nbsp;[|&nbsp;<span class="string">"name"</span>&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;remove_bookmark&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"push_location"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;push_location&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"pop_location"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;pop_location&nbsp;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"forward_location"</span>,&nbsp;[|&nbsp;|],&nbsp;<span class="constructor">None</span>,&nbsp;forward_location&nbsp;;<br>
&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;_&nbsp;=&nbsp;<span class="constructor">List</span>.iter<br>
&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(name,&nbsp;args,&nbsp;more,&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;register_com&nbsp;~prefix:&nbsp;factory_name&nbsp;name&nbsp;args&nbsp;?more&nbsp;f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;coms</code></body></html>